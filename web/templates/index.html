<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memento - Memory System</title>
  <link rel="stylesheet" href="/static/dist/assets/main.css">
  <!-- Cytoscape.js for graph visualization -->
  <script src="/static/vendor/cytoscape-3.30.4.min.js"></script>
  <script src="/static/vendor/layout-base-2.0.1.js"></script>
  <script src="/static/vendor/cose-base-2.2.0.js"></script>
  <script src="/static/vendor/cytoscape-fcose-2.2.0.js"></script>
  <!-- Chart.js for activity graph -->
  <script src="/static/vendor/chart-4.4.0.min.js"></script>
  <!-- Alpine.js - defer ensures it waits for DOM and executes after our app.js -->
  <script src="/static/vendor/alpine-3.14.9.min.js" defer></script>
  <!-- Theme: prevent FOUC. Default is dark mode. -->
  <script>
    (function() {
      var theme = localStorage.getItem('theme');
      if (theme === 'light') {
        document.documentElement.classList.add('light');
        document.documentElement.classList.remove('dark');
      } else {
        // Dark mode is the default
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
      }
    })();
  </script>
</head>
<body x-data="mementoApp" x-init="init()" class="min-h-screen transition-colors">
  <!-- Top Navigation Bar with Frosted Glass Effect -->
  <nav class="app-nav sticky top-0 z-40 backdrop-blur-lg border-b transition-all shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="flex items-center">
          <h1 class="text-xl font-bold text-gray-900 dark:text-white">üß† Memento</h1>
        </div>

        <!-- Page Navigation (Center) -->
        <div class="flex items-center space-x-4">
          <button @click="navigateTo('dashboard')"
                  :class="currentView === 'dashboard' ? 'font-bold text-gray-900 dark:text-white border-b-2 border-gray-900 dark:border-white' : 'text-gray-600 dark:text-gray-400'"
                  class="nav-btn hover:text-gray-900 dark:hover:text-white px-3 py-2 transition">üìä Dashboard</button>
          <button @click="navigateTo('feed')"
                  :class="currentView === 'feed' ? 'font-bold text-gray-900 dark:text-white border-b-2 border-gray-900 dark:border-white' : 'text-gray-600 dark:text-gray-400'"
                  class="nav-btn hover:text-gray-900 dark:hover:text-white px-3 py-2 transition">üì° Live Feed</button>
          <button @click="navigateTo('search')"
                  :class="currentView === 'search' ? 'font-bold text-gray-900 dark:text-white border-b-2 border-gray-900 dark:border-white' : 'text-gray-600 dark:text-gray-400'"
                  class="nav-btn hover:text-gray-900 dark:hover:text-white px-3 py-2 transition">üîç Search</button>
          <button @click="navigateTo('graph')"
                  :class="currentView === 'graph' ? 'font-bold text-gray-900 dark:text-white border-b-2 border-gray-900 dark:border-white' : 'text-gray-600 dark:text-gray-400'"
                  class="nav-btn hover:text-gray-900 dark:hover:text-white px-3 py-2 transition">üï∏ Graph</button>
        </div>

        <!-- Right Side: Status, Connection, Theme, Menu -->
        <div class="flex items-center space-x-3">
          <!-- WebSocket Status Indicator -->
          <div class="flex items-center">
            <span x-show="wsConnected"
                  class="h-3 w-3 rounded-full"
                  style="background-color: #10b981;"
                  title="Connected"></span>
            <span x-show="!wsConnected"
                  class="h-3 w-3 rounded-full"
                  style="background-color: #ef4444; animation: pulseSoft 1.5s ease-in-out infinite;"
                  title="Disconnected"></span>
          </div>

          <!-- Connection Switcher Dropdown -->
          <div class="hidden sm:block">
            <select x-model="activeConnection"
                    @change="switchConnection()"
                    class="field py-2 px-3 text-sm"
                    title="Switch connection">
              <option value="" disabled>Select connection...</option>
              <template x-for="conn in connections" :key="conn.name">
                <option :value="conn.name" x-text="`${conn.display_name || conn.name} (${conn.database?.type || 'sqlite'})`"></option>
              </template>
              <option x-show="connections.length === 0" disabled>No connections</option>
            </select>
          </div>

          <!-- Theme Toggle Button -->
          <button @click="toggleTheme()"
                  class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
                  title="Toggle theme">
            <svg x-show="!isDarkMode" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
            <svg x-show="isDarkMode" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          </button>

          <!-- Menu Dropdown (far right) -->
          <div class="relative" x-data="{ menuOpen: false }">
            <button @click="menuOpen = !menuOpen"
                    :class="['settings', 'debug', 'import', 'entities', 'relationships', 'queue'].includes(currentView) ? 'font-bold text-gray-900 dark:text-white border-b-2 border-gray-900 dark:border-white' : 'text-gray-600 dark:text-gray-400'"
                    class="nav-btn hover:text-gray-900 dark:hover:text-white px-3 py-2 transition"
                    aria-label="Menu">
              ‚ãÆ Menu ‚ñº
            </button>

            <!-- Dropdown Panel -->
            <div x-show="menuOpen"
                 @click.away="menuOpen = false"
                 x-transition
                 class="absolute right-0 mt-2 w-48 card-polished py-2 shadow-lg z-50"
                 style="display: none;">
              <button @click="navigateTo('entities'); menuOpen = false"
                      class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-300">
                üë§ Entities
              </button>
              <button @click="navigateTo('relationships'); menuOpen = false"
                      class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-300">
                üîó Relationships
              </button>
              <button @click="navigateTo('queue'); menuOpen = false"
                      class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-300">
                ‚è≥ Queue
              </button>
              <button @click="navigateTo('import'); menuOpen = false"
                      class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-300">
                üì• Import
              </button>
              <button @click="navigateTo('debug'); menuOpen = false"
                      class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-300">
                üî¨ Debug
              </button>
              <button @click="window.location.href='/integrations'; menuOpen = false"
                      class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-300">
                ‚ö° Integrations
              </button>
              <button @click="navigateTo('settings'); menuOpen = false"
                      class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-300">
                ‚öôÔ∏è Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content Area -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Dashboard Page -->
    <div x-show="currentView === 'dashboard'" x-transition>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Dashboard</h2>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Memories Card -->
        <div class="card-polished hover:shadow-elevation p-6 group cursor-pointer transition-all" @click="navigateTo('search')">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-gray-500 dark:text-gray-400 text-sm font-semibold uppercase tracking-wide">Total Memories</h3>
            <span class="text-3xl opacity-80 group-hover:opacity-100 transition-opacity">üß†</span>
          </div>
          <p class="text-4xl font-bold text-gray-900 dark:text-white" x-text="stats.memories || 0"></p>
          <div class="mt-4 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </div>

        <!-- Entities Card -->
        <div class="card-polished hover:shadow-elevation p-6 group cursor-pointer transition-all" @click="navigateTo('entities')">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-gray-500 dark:text-gray-400 text-sm font-semibold uppercase tracking-wide">Entities</h3>
            <span class="text-3xl opacity-80 group-hover:opacity-100 transition-opacity">üë§</span>
          </div>
          <p class="text-4xl font-bold text-gray-900 dark:text-white" x-text="stats.entities || 0"></p>
          <div class="mt-4 h-1 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </div>

        <!-- Relationships Card -->
        <div class="card-polished hover:shadow-elevation p-6 group cursor-pointer transition-all" @click="navigateTo('relationships')">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-gray-500 dark:text-gray-400 text-sm font-semibold uppercase tracking-wide">Relationships</h3>
            <span class="text-3xl opacity-80 group-hover:opacity-100 transition-opacity">üîó</span>
          </div>
          <p class="text-4xl font-bold text-gray-900 dark:text-white" x-text="stats.relationships || 0"></p>
          <div class="mt-4 h-1 bg-gradient-to-r from-green-400 to-green-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </div>

        <!-- Queue Card -->
        <div class="card-polished hover:shadow-elevation p-6 group cursor-pointer transition-all" @click="navigateTo('queue')">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-gray-500 dark:text-gray-400 text-sm font-semibold uppercase tracking-wide">Queue Size</h3>
            <span class="text-3xl opacity-80 group-hover:opacity-100 transition-opacity">‚è≥</span>
          </div>
          <p class="text-4xl font-bold text-gray-900 dark:text-white" x-text="stats.queueSize || 0"></p>
          <div class="mt-4 h-1 bg-gradient-to-r from-orange-400 to-orange-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </div>
      </div>

      <!-- Activity Chart -->
      <div class="mt-6">
        <div class="card-polished p-6">
          <!-- Header row: title + range selector -->
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-5">
            <div>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Memory Activity</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Memories created over time</p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <template x-for="r in [{id:'5min',label:'5 min'},{id:'1hour',label:'1 hour'},{id:'24hour',label:'24 hours'},{id:'week',label:'Week'}]" :key="r.id">
                <button
                  @click="activityRange = r.id; loadActivity(true)"
                  :class="activityRange === r.id
                    ? 'bg-cyan-500 text-white border-cyan-500 shadow-sm'
                    : 'text-gray-600 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:border-cyan-400 hover:text-cyan-500 dark:hover:text-cyan-400'"
                  class="btn-sm border rounded-md font-medium transition-all"
                  x-text="r.label">
                </button>
              </template>
            </div>
          </div>

          <!-- Chart canvas -->
          <div class="relative" style="height:200px;">
            <canvas id="activity-chart" x-ref="activityCanvas"></canvas>
            <!-- Empty state overlay -->
            <div x-show="activityEmpty && !activityLoading"
                 class="absolute inset-0 flex items-center justify-center pointer-events-none">
              <p class="text-gray-400 dark:text-gray-500 text-sm">No activity in this time range</p>
            </div>
            <!-- Loading overlay -->
            <div x-show="activityLoading"
                 class="absolute inset-0 flex items-center justify-center bg-opacity-50">
              <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-cyan-500"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live Feed Page -->
    <div x-show="currentView === 'feed'" x-transition>
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Live Feed</h2>
        <button @click="toggleLiveFeed()"
                class="card-polished px-4 py-2 text-sm font-medium transition-all hover:shadow-elevation"
                :class="liveFeedPaused ? 'text-green-600 dark:text-green-400' : 'text-yellow-600 dark:text-yellow-400'">
          <span x-show="!liveFeedPaused">‚è∏Ô∏è Pause Feed</span>
          <span x-show="liveFeedPaused">‚ñ∂Ô∏è Resume Feed</span>
        </button>
      </div>

      <!-- Loading State -->
      <div x-show="feedLoading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"></div>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Loading memories...</p>
      </div>

      <!-- Memory List -->
      <div x-show="!feedLoading" class="space-y-4">
        <template x-if="feedResults.length === 0">
          <div class="card-polished p-8 text-center">
            <p class="text-gray-600 dark:text-gray-400 text-lg">No memories yet. Create your first memory!</p>
          </div>
        </template>

        <template x-for="memory in feedResults" :key="memory.id">
          <div class="memory-card">
            <div class="memory-card-header">
              <h3 class="memory-card-title" x-text="memory.id"></h3>
              <span class="memory-card-status"
                    :class="{
                      'pending': memory.status === 'pending',
                      'complete': memory.status === 'complete',
                      'failed': memory.status === 'failed',
                      'enriched': memory.status === 'enriched'
                    }"
                    x-text="memory.status"></span>
            </div>
            <p class="memory-card-content" x-text="memory.content"></p>
            <div class="memory-card-footer">
              <span><span class="text-gray-600 dark:text-gray-400">Source:</span> <span class="memory-card-meta" x-text="memory.source"></span></span>
              <span class="hidden sm:inline text-gray-400 dark:text-gray-600">‚Ä¢</span>
              <span><span class="text-gray-600 dark:text-gray-400">Created:</span> <span class="memory-card-meta" x-text="new Date(memory.created_at).toLocaleString()"></span></span>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Search Page -->
    <div x-show="currentView === 'search'" x-transition>
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Search Memories</h2>

      <div class="card-polished p-6 mb-6">
        <input type="text"
               x-model="searchQuery"
               @input.debounce.500ms="performSearch()"
               placeholder="Search memories... or browse all below"
               class="input-field">
      </div>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Showing all memories. Type to search and filter.</p>

      <!-- Loading State -->
      <div x-show="searchLoading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"></div>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Searching...</p>
      </div>

      <!-- Search Results -->
      <div x-show="!searchLoading" class="space-y-4">

        <!-- Pagination Controls -->
        <div x-show="searchResults.length > 0" class="flex justify-between items-center mb-4 px-2">
          <div class="text-sm text-gray-600 dark:text-gray-400">
            <template x-if="searchQuery && searchQuery.trim()">
              <span>Found <span x-text="searchTotal"></span> results for "<span x-text="searchQuery"></span>"</span>
            </template>
            <template x-if="!searchQuery || !searchQuery.trim()">
              <span>Showing all <span x-text="searchTotal"></span> memories</span>
            </template>
          </div>

          <div class="flex items-center gap-3">
            <select x-model="searchPageSize" @change="changeSearchPageSize(searchPageSize)"
                    class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all w-24">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>

            <div class="flex items-center gap-2">
              <button @click="prevSearchPage()" :disabled="searchPage === 1"
                      class="px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed transition-all">
                ‚Üê Prev
              </button>
              <span class="text-sm text-gray-600 dark:text-gray-400">Page <span x-text="searchPage"></span></span>
              <button @click="nextSearchPage()" :disabled="!searchHasMore"
                      class="px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed transition-all">
                Next ‚Üí
              </button>
            </div>
          </div>
        </div>

        <template x-if="searchResults.length === 0 && searchQuery">
          <div class="card-polished p-8 text-center">
            <p class="text-gray-600 dark:text-gray-400 text-lg">No results found for "<span class="font-semibold" x-text="searchQuery"></span>"</p>
          </div>
        </template>

        <template x-if="searchResults.length === 0 && !searchLoading && (!searchQuery || !searchQuery.trim())">
          <div class="card-polished p-8 text-center">
            <p class="text-gray-600 dark:text-gray-400 text-lg">No memories found.</p>
          </div>
        </template>

        <template x-for="result in searchResults" :key="result.id">
          <div class="memory-card">
            <div class="flex justify-between items-start mb-3">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white group-hover:text-cyan-600 dark:group-hover:text-cyan-400 transition" x-text="result.id"></h3>
              <span class="memory-card-status" x-text="result.type"></span>
            </div>
            <p class="memory-card-content" x-text="result.content"></p>
            <div class="memory-card-footer">
              <span>Source: <span class="memory-card-meta" x-text="result.source"></span></span>
              <span>Created: <span class="memory-card-meta" x-text="new Date(result.created_at).toLocaleString()"></span></span>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Graph Explorer Page -->
    <div x-show="currentView === 'graph'" x-transition x-data="graphExplorer()" x-init="graphInit()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Graph Explorer</h2>
        <!-- Controls Bar - Polished Styling -->
        <div class="card-polished px-5 py-3 flex items-center gap-4">
          <!-- Depth selector -->
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Depth:</label>
            <select x-model.number="graphDepth" @change="reloadGraph()"
                    class="px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400 dark:focus:ring-cyan-500 focus:border-transparent transition-all cursor-pointer">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </div>
          <!-- Layout selector -->
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Layout:</label>
            <select x-model="graphLayout" @change="runLayout()"
                    class="px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400 dark:focus:ring-cyan-500 focus:border-transparent transition-all cursor-pointer">
              <option value="fcose">fCoSE (clustered)</option>
              <option value="cose">CoSE</option>
              <option value="circle">Circle</option>
              <option value="concentric">Concentric</option>
              <option value="grid">Grid</option>
            </select>
          </div>
          <!-- Fit button -->
          <button @click="fitGraph()" class="btn-primary text-sm px-4 py-1.5" title="Fit graph to viewport">Fit to Viewport</button>
        </div>
      </div>

      <!-- Entity Search / Autocomplete -->
      <div class="card-polished p-6 mb-6 hover:shadow-elevation transition-all">
        <div class="relative">
          <label class="section-label">Find Entity</label>
          <input type="text"
                 x-model="entitySearch"
                 @input.debounce.300ms="searchEntities()"
                 @focus="showEntityDropdown = entitySearchResults.length > 0"
                 @keydown.escape="showEntityDropdown = false"
                 placeholder="Search for an entity to center the graph on..."
                 class="input-field w-full">
          <!-- Dropdown results -->
          <div x-show="showEntityDropdown && entitySearchResults.length > 0"
               @click.outside="showEntityDropdown = false"
               class="absolute z-10 w-full mt-2 bg-white/95 dark:bg-gray-800/95 border border-gray-200/50 dark:border-gray-600/50 rounded-lg shadow-lg backdrop-blur-sm max-h-64 overflow-y-auto">
            <template x-for="entity in entitySearchResults" :key="entity.id">
              <button @click="selectEntity(entity)"
                      class="w-full text-left px-4 py-3 hover:bg-cyan-50 dark:hover:bg-gray-700/50 flex items-center gap-3 border-b border-gray-100 dark:border-gray-700/50 last:border-0 text-gray-900 dark:text-white transition-colors duration-150">
                <span class="inline-block w-3 h-3 rounded-full flex-shrink-0" :style="'background-color:' + getTypeColor(entity.type)"></span>
                <div class="flex-1 min-w-0">
                  <span class="font-medium text-sm block truncate" x-text="entity.name"></span>
                  <span class="text-xs text-gray-500 dark:text-gray-400 block" x-text="entity.memory_count + ' memories'"></span>
                </div>
                <span class="badge-info text-xs flex-shrink-0" x-text="entity.type"></span>
              </button>
            </template>
          </div>
        </div>
        <!-- Current selection -->
        <div x-show="selectedEntity" class="mt-5 flex flex-wrap items-center gap-3">
          <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Showing:</span>
          <span class="inline-flex items-center gap-2 px-4 py-2 bg-cyan-100/50 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-300 rounded-full text-sm font-semibold border border-cyan-200/50 dark:border-cyan-700/50 backdrop-blur-sm">
            <span class="inline-block w-2.5 h-2.5 rounded-full flex-shrink-0" :style="selectedEntity ? 'background-color:' + getTypeColor(selectedEntity.type) : ''"></span>
            <span class="truncate" x-text="selectedEntity ? selectedEntity.name : ''"></span>
            <button @click="clearSelection()" class="ml-1 text-cyan-600 dark:text-cyan-400 hover:text-cyan-800 dark:hover:text-cyan-300 font-bold opacity-70 hover:opacity-100 transition" title="Clear selection">&times;</button>
          </span>
          <span class="text-xs text-gray-500 dark:text-gray-400 font-medium whitespace-nowrap" x-text="graphMeta.node_count + ' nodes, ' + graphMeta.edge_count + ' edges'"></span>
        </div>
      </div>

      <!-- Loading -->
      <div x-show="graphLoading" class="text-center py-20">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-3 border-blue-200 border-t-blue-600 dark:border-gray-600 dark:border-t-blue-400"></div>
        <p class="mt-4 text-gray-600 dark:text-gray-400 font-medium">Loading graph...</p>
      </div>

      <!-- Empty state -->
      <div x-show="!graphLoading && !selectedEntity" class="card-polished p-12 text-center">
        <p class="text-gray-600 dark:text-gray-400 text-lg mb-2 font-medium">Search for an entity above to visualize its graph neighborhood.</p>
        <p class="text-gray-500 dark:text-gray-400 text-sm">The graph will show related entities and their relationships.</p>
      </div>

      <!-- Graph container -->
      <div x-show="!graphLoading && selectedEntity"
           class="card-polished hover:shadow-elevation overflow-hidden transition-all" style="position: relative;">
        <div id="cy" class="graph-container" style="width: 100%; height: 600px;"></div>
        <!-- Node detail tooltip (shown on hover/click) -->
        <div x-show="hoveredNode" x-transition
             class="absolute top-4 right-4 z-20 max-w-xs"
             style="pointer-events: none;">
          <div class="card-polished p-5 bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm">
            <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
              <span class="inline-block w-3.5 h-3.5 rounded-full flex-shrink-0" :style="hoveredNode ? 'background-color:' + getTypeColor(hoveredNode.type) : ''"></span>
              <span class="font-semibold text-gray-900 dark:text-white truncate" x-text="hoveredNode ? hoveredNode.name : ''"></span>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between items-start">
                <span class="text-gray-600 dark:text-gray-400 font-medium">Type:</span>
                <span class="badge-info text-xs" x-text="hoveredNode ? hoveredNode.type : ''"></span>
              </div>
              <template x-if="hoveredNode && hoveredNode.description">
                <div>
                  <span class="text-gray-600 dark:text-gray-400 font-medium block mb-1">Description:</span>
                  <p class="text-gray-700 dark:text-gray-300 text-xs leading-relaxed" x-text="hoveredNode ? hoveredNode.description : ''"></p>
                </div>
              </template>
              <div class="flex justify-between items-center pt-1">
                <span class="text-gray-600 dark:text-gray-400 font-medium">Memories:</span>
                <span class="text-gray-900 dark:text-white font-semibold" x-text="hoveredNode ? hoveredNode.memory_count : ''"></span>
              </div>
            </div>
          </div>
        </div>
        <!-- Legend - Polished -->
        <div class="absolute bottom-4 left-4 z-20">
          <div class="card-polished p-5 bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm max-w-xs">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-lg">üè∑Ô∏è</span>
              <h3 class="font-semibold text-gray-900 dark:text-white">Entity Types</h3>
            </div>
            <div class="space-y-2" x-show="graphTypeLegend.length > 0">
              <template x-for="item in graphTypeLegend" :key="item.type">
                <div class="flex items-center gap-3 py-1.5 px-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150">
                  <span class="inline-block w-3 h-3 rounded-full flex-shrink-0" :style="'background-color:' + item.color"></span>
                  <span class="text-sm text-gray-700 dark:text-gray-300 font-medium capitalize" x-text="item.type"></span>
                </div>
              </template>
            </div>
            <div x-show="graphTypeLegend.length === 0" class="text-xs text-gray-500 dark:text-gray-400 italic py-2">
              Load a graph to see entity types
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Page -->
    <div x-show="currentView === 'debug'" x-transition x-data="debugApp()" x-init="debugInit()">
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-8">Debug: Recall Trace</h2>

      <!-- Query Form -->
      <div class="card-polished p-6 mb-6 hover:shadow-elevation transition-all">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Debug a Recall Query</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search Query</label>
            <input type="text"
                   x-model="form.query"
                   @keydown.enter="runTrace()"
                   placeholder="e.g. project goals"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Domain / State Filter</label>
            <input type="text"
                   x-model="form.state"
                   placeholder="e.g. work (optional)"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Min Score (0.0 ‚Äì 1.0)</label>
            <input type="number" step="0.01" min="0" max="1"
                   x-model.number="form.minScore"
                   placeholder="0.0"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Limit</label>
            <input type="number" min="1" max="100"
                   x-model.number="form.limit"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="flex items-end">
            <button @click="runTrace()"
                    :disabled="debugLoading"
                    class="w-full px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition disabled:opacity-50">
              <span x-show="!debugLoading">üîç Run Trace</span>
              <span x-show="debugLoading">‚è≥ Running...</span>
            </button>
          </div>
        </div>
        <div x-show="debugError" class="mt-4 p-4 bg-red-100 dark:bg-red-900 border border-red-500 text-red-800 dark:text-red-200 rounded-lg text-sm" x-text="debugError"></div>
      </div>

      <!-- Results (shown only after a trace has run) -->
      <div x-show="debugResult" x-transition>

        <!-- Summary Banner -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="card-polished p-6 text-center hover:shadow-elevation transition-all">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-2">Candidates Found</p>
            <p class="text-4xl font-bold text-gray-900 dark:text-white" x-text="debugResult?.candidates_found ?? 0"></p>
          </div>
          <div class="card-polished p-6 text-center hover:shadow-elevation transition-all">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-2">Scored</p>
            <p class="text-4xl font-bold text-yellow-600 dark:text-yellow-400" x-text="debugResult?.scored_results?.length ?? 0"></p>
          </div>
          <div class="card-polished p-6 text-center hover:shadow-elevation transition-all">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-2">Returned</p>
            <p class="text-4xl font-bold text-green-600 dark:text-green-400" x-text="debugResult?.returned?.length ?? 0"></p>
          </div>
          <div class="card-polished p-6 text-center hover:shadow-elevation transition-all">
            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-2">Filtered Out</p>
            <p class="text-4xl font-bold text-red-600 dark:text-red-400" x-text="debugResult?.filtered_out?.length ?? 0"></p>
          </div>
        </div>

        <!-- Timing & Query Params -->
        <div class="card-polished p-6 mb-6 hover:shadow-elevation transition-all">
          <h3 class="section-label mb-4">Query Parameters & Timing</h3>
          <div class="flex flex-wrap gap-6 text-sm">
            <div>
              <span class="font-medium text-gray-700 dark:text-gray-300">Query:</span>
              <span class="ml-2 font-mono bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded text-gray-900 dark:text-white" x-text="debugResult?.query_params?.query || '(empty)'"></span>
            </div>
            <template x-if="debugResult?.query_params?.domain">
              <div>
                <span class="font-medium text-gray-700 dark:text-gray-300">Domain:</span>
                <span class="ml-2 font-mono bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded text-gray-900 dark:text-white" x-text="debugResult?.query_params?.domain"></span>
              </div>
            </template>
            <template x-if="debugResult?.query_params?.min_score">
              <div>
                <span class="font-medium text-gray-700 dark:text-gray-300">Min Score:</span>
                <span class="ml-2 font-mono bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded text-gray-900 dark:text-white" x-text="debugResult?.query_params?.min_score"></span>
              </div>
            </template>
            <div>
              <span class="font-medium text-gray-700 dark:text-gray-300">Timing:</span>
              <span class="ml-2 font-mono bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded text-gray-900 dark:text-white" x-text="(debugResult?.timing_ms ?? 0) + ' ms'"></span>
            </div>
          </div>
        </div>

        <!-- Scored Results (included) -->
        <div class="card-polished mb-6 hover:shadow-elevation transition-all">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
              Scored Candidates
              <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2">
                (green = returned, yellow = scored but not in page)
              </span>
            </h3>
          </div>
          <div class="divide-y divide-gray-200 dark:divide-gray-700">
            <template x-if="!debugResult?.scored_results?.length">
              <div class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">No scored candidates.</div>
            </template>
            <template x-for="entry in debugResult?.scored_results || []" :key="entry.memory_id">
              <details class="px-6 py-4">
                <summary class="flex items-center justify-between cursor-pointer">
                  <div class="flex items-center gap-3">
                    <span class="text-xs px-3 py-1 rounded font-medium"
                          :class="debugIsReturned(entry.memory_id) ? 'badge-debug-included' : 'badge-debug-candidate'"
                          x-text="debugIsReturned(entry.memory_id) ? 'INCLUDED' : 'CONSIDERED'">
                    </span>
                    <span class="font-mono text-sm text-gray-900 dark:text-white" x-text="entry.memory_id"></span>
                  </div>
                  <div class="flex items-center gap-4">
                    <!-- Total score bar -->
                    <div class="hidden md:flex items-center gap-2">
                      <div class="w-32 h-2 bg-gray-200 dark:bg-gray-700 rounded-full">
                        <div class="h-2 rounded-full transition-all"
                             :class="debugTotalScoreColor(entry.total)"
                             :style="'width:' + (entry.total * 100).toFixed(1) + '%'">
                        </div>
                      </div>
                      <span class="text-sm font-medium text-gray-700 dark:text-gray-300 min-w-fit" x-text="entry.total.toFixed(3)"></span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 dark:text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </div>
                </summary>
                <!-- Score breakdown -->
                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
                  <template x-for="[label, val] in debugScoreBreakdown(entry)" :key="label">
                    <div class="bg-gray-50 dark:bg-gray-700 rounded p-3">
                      <p class="text-xs text-gray-500 dark:text-gray-400 mb-2 font-medium" x-text="label"></p>
                      <div class="w-full h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full mb-2">
                        <div class="h-1.5 rounded-full bg-blue-400 dark:bg-blue-500"
                             :style="'width:' + (val * 100).toFixed(1) + '%'"></div>
                      </div>
                      <p class="text-sm font-medium text-gray-800 dark:text-white" x-text="val.toFixed(3)"></p>
                    </div>
                  </template>
                </div>
              </details>
            </template>
          </div>
        </div>

        <!-- Filtered Out -->
        <div class="card-polished mb-6 hover:shadow-elevation transition-all">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Filtered Out</h3>
          </div>
          <div class="divide-y divide-gray-200 dark:divide-gray-700">
            <template x-if="!debugResult?.filtered_out?.length">
              <div class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">No memories were filtered out.</div>
            </template>
            <template x-for="entry in debugResult?.filtered_out || []" :key="entry.memory_id">
              <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="badge-debug-filtered text-xs px-3 py-1 rounded font-medium">FILTERED</span>
                  <span class="font-mono text-sm text-gray-900 dark:text-white" x-text="entry.memory_id"></span>
                </div>
                <span class="text-sm text-red-600 dark:text-red-400" x-text="entry.reason"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- Returned IDs -->
        <div class="card-polished hover:shadow-elevation transition-all">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Final Returned IDs</h3>
          </div>
          <div class="px-6 py-4">
            <template x-if="!debugResult?.returned?.length">
              <p class="text-gray-500 dark:text-gray-400">No memories returned.</p>
            </template>
            <div class="flex flex-wrap gap-2">
              <template x-for="id in debugResult?.returned || []" :key="id">
                <span class="badge-debug-included text-xs px-3 py-1 rounded-full font-mono" x-text="id"></span>
              </template>
            </div>
          </div>
        </div>

      </div><!-- /debugResult -->
    </div>

    <!-- Settings Page -->
    <div x-show="currentView === 'settings'" x-transition>
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Settings</h2>
        <button @click="openAddConnectionModal()"
                class="px-4 py-2 bg-green-600 dark:bg-green-700 text-white rounded-lg hover:bg-green-700 dark:hover:bg-green-600 transition text-sm font-medium">
          ‚ûï Add Connection
        </button>
      </div>

      <div class="space-y-6">
        <!-- Connection Details (Active) -->
        <div class="card-polished p-6 hover:shadow-elevation transition-all">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Active Connection Details</h3>
            <button @click="openAddConnectionModal(getActiveConnectionData())"
                    class="btn-primary text-sm">
              ‚úèÔ∏è Edit Connection
            </button>
          </div>

          <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
            <div>
              <label class="text-xs text-gray-600 dark:text-gray-400 font-medium">Display Name</label>
              <p class="text-gray-900 dark:text-white font-semibold" x-text="getActiveConnectionData()?.display_name || 'Default'"></p>
            </div>
            <div>
              <label class="text-xs text-gray-600 dark:text-gray-400 font-medium">Database Type</label>
              <p class="text-gray-900 dark:text-white font-semibold" x-text="(getActiveConnectionData()?.database?.type || 'sqlite').toUpperCase()"></p>
            </div>
            <div class="col-span-2">
              <label class="text-xs text-gray-600 dark:text-gray-400 font-medium">Location</label>
              <p class="text-gray-900 dark:text-white font-mono text-sm" x-text="getActiveConnectionData()?.database?.path || getActiveConnectionData()?.database?.host || './data/memento.db'"></p>
            </div>
          </div>
        </div>

        <!-- User Configuration (Display Only) -->
        <div class="card-polished p-6 hover:shadow-elevation transition-all">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">User Configuration</h3>
            <button @click="openUserConfigModal()"
                    class="btn-primary text-sm">
              ‚úèÔ∏è Edit
            </button>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
              <span class="text-gray-700 dark:text-gray-300">User Name</span>
              <span class="font-medium text-gray-900 dark:text-white" x-text="userConfig.userName || 'Not set'"></span>
            </div>
          </div>
        </div>

        <!-- System Configuration (Connection-specific) -->
        <div class="card-polished p-6 hover:shadow-elevation transition-all">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Connection Configuration</h3>
            <button @click="editConnectionSettings()"
                    class="btn-primary text-sm">
              ‚úèÔ∏è Edit
            </button>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
              <span class="text-gray-700 dark:text-gray-300">LLM Provider</span>
              <span class="font-medium text-gray-900 dark:text-white" x-text="getActiveConnectionData()?.llm?.provider || 'Not configured'"></span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
              <span class="text-gray-700 dark:text-gray-300">LLM Model</span>
              <span class="font-medium text-gray-900 dark:text-white" x-text="getActiveConnectionData()?.llm?.model || 'Not configured'"></span>
            </div>
            <div class="flex justify-between items-center py-2">
              <span class="text-gray-700 dark:text-gray-300">LLM Base URL</span>
              <span class="font-medium text-gray-900 dark:text-white text-sm" x-text="getActiveConnectionData()?.llm?.base_url || 'Default'"></span>
            </div>
          </div>
        </div>

        <!-- System Status -->
        <div class="card-polished p-6 hover:shadow-elevation transition-all">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">System Status</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
              <span class="text-gray-700 dark:text-gray-300">WebSocket Connection</span>
              <span class="font-medium" :class="wsConnected ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'">
                <span x-show="wsConnected">‚úì Connected</span>
                <span x-show="!wsConnected">‚úó Disconnected</span>
              </span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
              <span class="text-gray-700 dark:text-gray-300">Enrichment Queue</span>
              <span class="font-medium text-gray-900 dark:text-white" x-text="stats.queueSize + ' items'"></span>
            </div>
            <div class="flex justify-between items-center py-2">
              <span class="text-gray-700 dark:text-gray-300">Total Memories</span>
              <span class="font-medium text-gray-900 dark:text-white" x-text="stats.memories"></span>
            </div>
          </div>
        </div>

        <!-- Taxonomy Settings -->
        <div class="card-polished p-6 hover:shadow-elevation transition-all">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Taxonomy Settings</h3>
            <span x-show="taxonomyLoading" class="text-sm text-gray-500 dark:text-gray-400">
              <span class="inline-block animate-spin">‚ü≥</span> Loading...
            </span>
          </div>

          <!-- Tabs -->
          <div class="flex gap-2 border-b border-gray-200 dark:border-gray-700 mb-6 overflow-x-auto">
            <button @click="taxonomyActiveTab = 'entities'"
                    :class="taxonomyActiveTab === 'entities' ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-950' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'"
                    class="px-5 py-2 font-medium text-sm transition rounded-t-lg whitespace-nowrap">Entities</button>
            <button @click="taxonomyActiveTab = 'relationships'"
                    :class="taxonomyActiveTab === 'relationships' ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-950' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'"
                    class="px-5 py-2 font-medium text-sm transition rounded-t-lg whitespace-nowrap">Relationships</button>
            <button @click="taxonomyActiveTab = 'memory-types'"
                    :class="taxonomyActiveTab === 'memory-types' ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-950' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'"
                    class="px-5 py-2 font-medium text-sm transition rounded-t-lg whitespace-nowrap">Memory Types</button>
            <button @click="taxonomyActiveTab = 'classifications'"
                    :class="taxonomyActiveTab === 'classifications' ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-950' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'"
                    class="px-5 py-2 font-medium text-sm transition rounded-t-lg whitespace-nowrap">Classifications</button>
          </div>

          <!-- Success/Error Messages -->
          <div x-show="taxonomySaveSuccess" class="mb-4 p-3 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300 rounded-lg text-sm border border-green-200 dark:border-green-800">
            <span x-text="taxonomySaveSuccess"></span>
          </div>
          <div x-show="taxonomySaveError" class="mb-4 p-3 bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-300 rounded-lg text-sm border border-red-200 dark:border-red-800">
            <span x-text="taxonomySaveError"></span>
          </div>

          <!-- Entities Tab -->
          <div x-show="taxonomyActiveTab === 'entities'" class="space-y-5">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-2">System Defaults</p>
              <div class="flex flex-wrap gap-2 p-3 bg-gray-50 dark:bg-gray-800/60 rounded-lg min-h-[40px]">
                <template x-for="type in (taxonomySettings?.system_entity_types || [])" :key="type">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 border border-blue-200 dark:border-blue-800">
                    <span x-text="type"></span>
                  </span>
                </template>
                <span x-show="!taxonomySettings" class="text-xs text-gray-400 dark:text-gray-500 italic">Loading...</span>
              </div>
            </div>
            <div>
              <div class="flex justify-between items-center mb-2">
                <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Custom Additions</p>
                <button @click="openTaxonomyModal('entities')"
                        class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-lg transition">
                  + Add Entity Type
                </button>
              </div>
              <div class="flex flex-wrap gap-2 p-3 bg-gray-50 dark:bg-gray-800/60 rounded-lg min-h-[44px]">
                <template x-for="(type, idx) in editingEntityTypes" :key="idx">
                  <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-300 border border-purple-200 dark:border-purple-800 cursor-pointer group hover:bg-purple-200 dark:hover:bg-purple-800/60 transition">
                    <span @click="openTaxonomyModal('entities', idx)" x-text="type.name || type.id"></span>
                    <button @click.stop="confirmRemoveEntityType(idx)" class="ml-0.5 text-purple-500 dark:text-purple-400 hover:text-red-600 dark:hover:text-red-400 font-bold leading-none transition">√ó</button>
                  </span>
                </template>
                <span x-show="editingEntityTypes.length === 0" class="text-xs text-gray-400 dark:text-gray-500 italic self-center">No custom entity types added yet</span>
              </div>
            </div>
          </div>

          <!-- Relationships Tab -->
          <div x-show="taxonomyActiveTab === 'relationships'" class="space-y-5">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-2">System Defaults</p>
              <div class="flex flex-wrap gap-2 p-3 bg-gray-50 dark:bg-gray-800/60 rounded-lg min-h-[40px]">
                <template x-for="type in (taxonomySettings?.system_relationship_types || [])" :key="type">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 border border-blue-200 dark:border-blue-800">
                    <span x-text="type"></span>
                  </span>
                </template>
                <span x-show="!taxonomySettings" class="text-xs text-gray-400 dark:text-gray-500 italic">Loading...</span>
              </div>
            </div>
            <div>
              <div class="flex justify-between items-center mb-2">
                <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Custom Additions</p>
                <button @click="openTaxonomyModal('relationships')"
                        class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-lg transition">
                  + Add Relationship
                </button>
              </div>
              <div class="flex flex-wrap gap-2 p-3 bg-gray-50 dark:bg-gray-800/60 rounded-lg min-h-[44px]">
                <template x-for="(type, idx) in editingRelTypes" :key="idx">
                  <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-300 border border-purple-200 dark:border-purple-800 cursor-pointer group hover:bg-purple-200 dark:hover:bg-purple-800/60 transition">
                    <span @click="openTaxonomyModal('relationships', idx)" x-text="type.name || type.id"></span>
                    <span x-show="type.bidirectional" class="text-purple-400 dark:text-purple-500 text-xs">‚áÑ</span>
                    <button @click.stop="confirmRemoveRelType(idx)" class="ml-0.5 text-purple-500 dark:text-purple-400 hover:text-red-600 dark:hover:text-red-400 font-bold leading-none transition">√ó</button>
                  </span>
                </template>
                <span x-show="editingRelTypes.length === 0" class="text-xs text-gray-400 dark:text-gray-500 italic self-center">No custom relationship types added yet</span>
              </div>
            </div>
          </div>

          <!-- Memory Types Tab -->
          <div x-show="taxonomyActiveTab === 'memory-types'" class="space-y-5">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-2">System Defaults</p>
              <div class="flex flex-wrap gap-2 p-3 bg-gray-50 dark:bg-gray-800/60 rounded-lg min-h-[40px]">
                <template x-for="type in (taxonomySettings?.system_memory_types || [])" :key="type">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 border border-blue-200 dark:border-blue-800">
                    <span x-text="type"></span>
                  </span>
                </template>
                <span x-show="!taxonomySettings" class="text-xs text-gray-400 dark:text-gray-500 italic">Loading...</span>
              </div>
            </div>
            <div>
              <div class="flex justify-between items-center mb-2">
                <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Custom Additions</p>
                <button @click="openTaxonomyModal('memory-types')"
                        class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-lg transition">
                  + Add Memory Type
                </button>
              </div>
              <div class="flex flex-wrap gap-2 p-3 bg-gray-50 dark:bg-gray-800/60 rounded-lg min-h-[44px]">
                <template x-for="(type, idx) in editingMemoryTypes" :key="idx">
                  <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-300 border border-purple-200 dark:border-purple-800 cursor-pointer group hover:bg-purple-200 dark:hover:bg-purple-800/60 transition">
                    <span @click="openTaxonomyModal('memory-types', idx)" x-text="type.name || type.id"></span>
                    <button @click.stop="confirmRemoveMemoryType(idx)" class="ml-0.5 text-purple-500 dark:text-purple-400 hover:text-red-600 dark:hover:text-red-400 font-bold leading-none transition">√ó</button>
                  </span>
                </template>
                <span x-show="editingMemoryTypes.length === 0" class="text-xs text-gray-400 dark:text-gray-500 italic self-center">No custom memory types added yet</span>
              </div>
            </div>
          </div>

          <!-- Classifications Tab -->
          <div x-show="taxonomyActiveTab === 'classifications'" class="space-y-6">

            <!-- Active category selector -->
            <div>
              <label class="block text-sm font-semibold text-gray-800 dark:text-gray-200 mb-1">Active Category</label>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Which category is used when classifying memories for this connection.</p>
              <select x-model="selectedClassificationCategory"
                      @change="saveActiveClassificationCategory()"
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‚Äî No category selected ‚Äî</option>
                <template x-for="schema in (taxonomySettings?.all_classification_schemas || [])" :key="schema.category">
                  <option :value="schema.category" x-text="schema.category + (editingClassifications.some(c => c.category === schema.category) ? ' (custom)' : '')"></option>
                </template>
              </select>
            </div>

            <!-- Edit/Remove for selected custom category -->
            <template x-if="selectedClassificationCategory && editingClassifications.some(s => s.category === selectedClassificationCategory)">
              <div class="flex items-center gap-3">
                <button @click="openTaxonomyModal('classifications-cat', editingClassifications.findIndex(s => s.category === selectedClassificationCategory))"
                        class="text-xs text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition">Edit selected category</button>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <button @click="confirmRemoveClassificationCategory(editingClassifications.findIndex(s => s.category === selectedClassificationCategory))"
                        class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition">Remove</button>
              </div>
            </template>

            <!-- Add category -->
            <div class="flex justify-end">
              <button @click="openTaxonomyModal('classifications-cat')"
                      class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-lg transition">
                + Add Category
              </button>
            </div>
          </div>
        </div>

        <!-- Maintenance -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
             x-data="{
               maintenanceStatus: null,
               maintenanceLoading: false,
               backfillRunning: false,
               backfillMessage: '',
               async loadMaintenance() {
                 this.maintenanceLoading = true;
                 try {
                   const connName = activeConnection || 'default';
                   const r = await fetch('/api/connections/' + connName + '/maintenance', {
                     headers: { 'Content-Type': 'application/json' }
                   });
                   if (r.ok) this.maintenanceStatus = await r.json();
                 } catch(e) { console.error(e); }
                 this.maintenanceLoading = false;
               },
               async runBackfill(type) {
                 this.backfillRunning = true;
                 this.backfillMessage = '';
                 try {
                   const connName = activeConnection || 'default';
                   const r = await fetch('/api/connections/' + connName + '/maintenance/backfill', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({type: type})
                   });
                   const data = await r.json();
                   this.backfillMessage = data.message || ('Queued ' + data.queued + ' items');
                   await this.loadMaintenance();
                 } catch(e) { this.backfillMessage = 'Error: ' + e.message; }
                 this.backfillRunning = false;
               }
             }"
             x-init="loadMaintenance()">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Maintenance</h3>
            <button @click="loadMaintenance()" class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">Refresh</button>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
            Scoped to the active connection: <span class="font-medium" x-text="activeConnection || 'default'"></span>
          </p>

          <!-- Status cards -->
          <div x-show="maintenanceLoading" class="text-sm text-gray-500">Loading...</div>
          <div x-show="!maintenanceLoading && maintenanceStatus" class="space-y-3">

            <!-- Stats row -->
            <div class="grid grid-cols-3 gap-3">
              <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-orange-500" x-text="maintenanceStatus?.needs_enrichment ?? '‚Äî'"></div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Need Enrichment</div>
              </div>
              <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-blue-500" x-text="maintenanceStatus?.missing_embeddings ?? '‚Äî'"></div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Missing Embeddings</div>
              </div>
              <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 text-center">
                <div class="text-2xl font-bold"
                     :class="(maintenanceStatus?.model_mismatches ?? 0) > 0 ? 'text-red-500' : 'text-green-500'"
                     x-text="maintenanceStatus?.model_mismatches ?? '‚Äî'"></div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Model Mismatches</div>
              </div>
            </div>

            <!-- Model mismatch warning -->
            <div x-show="(maintenanceStatus?.model_mismatches ?? 0) > 0"
                 class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3">
              <p class="text-sm text-amber-800 dark:text-amber-200">
                <span x-text="maintenanceStatus?.model_mismatches"></span> embeddings were generated with a different model than the current
                <strong x-text="maintenanceStatus?.current_model || 'configured model'"></strong>.
                Re-embed all to fix semantic search.
              </p>
            </div>

            <!-- Action buttons -->
            <div class="flex flex-wrap gap-2 pt-2">
              <button @click="runBackfill('enrichment')"
                      :disabled="backfillRunning || maintenanceStatus?.needs_enrichment === 0"
                      class="px-3 py-2 text-sm bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-lg hover:bg-orange-200 disabled:opacity-40 disabled:cursor-not-allowed">
                <span x-show="!backfillRunning">Re-enrich (<span x-text="maintenanceStatus?.needs_enrichment"></span>)</span>
                <span x-show="backfillRunning">Running...</span>
              </button>
              <button @click="runBackfill('embeddings')"
                      :disabled="backfillRunning || maintenanceStatus?.missing_embeddings === 0"
                      class="px-3 py-2 text-sm bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 disabled:opacity-40 disabled:cursor-not-allowed">
                <span x-show="!backfillRunning">Generate Embeddings (<span x-text="maintenanceStatus?.missing_embeddings"></span>)</span>
                <span x-show="backfillRunning">Running...</span>
              </button>
              <button @click="runBackfill('re-embed-all')"
                      :disabled="backfillRunning"
                      x-show="(maintenanceStatus?.model_mismatches ?? 0) > 0"
                      class="px-3 py-2 text-sm bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg hover:bg-red-200 disabled:opacity-40 disabled:cursor-not-allowed">
                <span x-show="!backfillRunning">Re-embed All</span>
                <span x-show="backfillRunning">Running...</span>
              </button>
            </div>

            <!-- Feedback message -->
            <div x-show="backfillMessage"
                 class="text-sm text-green-700 dark:text-green-300 bg-green-50 dark:bg-green-900/20 rounded p-2 mt-2"
                 x-text="backfillMessage"></div>
          </div>
        </div>

        <!-- Unrecognized Types -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
             x-data="{
               unknownTypes: null,
               unknownLoading: false,
               async loadUnknownTypes() {
                 this.unknownLoading = true;
                 try {
                   const connName = activeConnection || 'default';
                   const r = await fetch('/api/connections/' + connName + '/maintenance/unknown-types');
                   if (r.ok) this.unknownTypes = await r.json();
                 } catch(e) { console.error(e); }
                 this.unknownLoading = false;
               }
             }"
             x-init="loadUnknownTypes()">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Unrecognized Types</h3>
            <button @click="loadUnknownTypes()" class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">Refresh</button>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Types returned by the LLM that weren't in your allowed list. Frequently-seen ones can be added as custom types in the Taxonomy settings above.</p>

          <div x-show="unknownLoading" class="text-sm text-gray-500">Loading...</div>
          <div x-show="!unknownLoading && unknownTypes" class="space-y-4">

            <!-- Entity types -->
            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-2">Entity Types</div>
              <div x-show="unknownTypes?.entities?.length === 0" class="text-sm text-gray-400 dark:text-gray-500 italic">None observed yet.</div>
              <div class="flex flex-wrap gap-2">
                <template x-for="t in (unknownTypes?.entities || [])" :key="t.type_name">
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 border border-purple-200 dark:border-purple-700">
                    <span x-text="t.type_name"></span>
                    <span class="bg-purple-200 dark:bg-purple-700 text-purple-800 dark:text-purple-200 rounded-full px-1.5 py-0.5 text-[10px] font-bold" x-text="t.count"></span>
                  </span>
                </template>
              </div>
            </div>

            <!-- Relationship types -->
            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-2">Relationship Types</div>
              <div x-show="unknownTypes?.relationships?.length === 0" class="text-sm text-gray-400 dark:text-gray-500 italic">None observed yet.</div>
              <div class="flex flex-wrap gap-2">
                <template x-for="t in (unknownTypes?.relationships || [])" :key="t.type_name">
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 border border-teal-200 dark:border-teal-700">
                    <span x-text="t.type_name"></span>
                    <span class="bg-teal-200 dark:bg-teal-700 text-teal-800 dark:text-teal-200 rounded-full px-1.5 py-0.5 text-[10px] font-bold" x-text="t.count"></span>
                  </span>
                </template>
              </div>
            </div>

          </div>
        </div>

        <!-- Actions -->
        <div class="card-polished p-6 hover:shadow-elevation transition-all">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Actions</h3>
          <div class="space-y-3">
            <button @click="refreshStats()"
                    class="w-full px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition">
              üîÑ Refresh Stats
            </button>
            <button class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition" disabled>
              üíæ Backup Database (Coming Soon)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit User Configuration Modal -->
    <div x-show="userConfigModalOpen"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4"
         style="display: none;">
      <div class="bg-white dark:bg-gray-900 rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between items-center">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Edit User Configuration</h3>
          <button @click="closeUserConfigModal()"
                  class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl leading-none">
            ‚úï
          </button>
        </div>

        <div class="px-6 py-4 space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">User Name</label>
            <input type="text"
                   x-model="editingUserConfig.userName"
                   placeholder="Enter your name"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>

        <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex gap-3 justify-end bg-gray-50 dark:bg-gray-800">
          <button @click="closeUserConfigModal()"
                  type="button"
                  class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
            Cancel
          </button>
          <button @click="saveUserConfigModal()"
                  type="button"
                  class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition">
            üíæ Save
          </button>
        </div>
      </div>
    </div>

    <!-- Taxonomy Item Modal -->
    <div x-show="taxonomyModalOpen"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4"
         style="display: none;"
         @keydown.escape.window="taxonomyModalOpen = false">
      <div class="bg-white/95 dark:bg-gray-800/95 rounded-lg shadow-lg backdrop-blur-sm max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/20 dark:border-gray-700/30">

        <!-- Header ‚Äî matches Add New Connection exactly -->
        <div class="sticky top-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm border-b border-gray-200/50 dark:border-gray-700/50 p-6 flex justify-between items-center">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white"
              x-text="taxonomyModalSection === 'classifications-cat' ? (taxonomyModalEditIndex >= 0 ? 'Edit Category' : 'Add Category') : (taxonomyModalEditIndex >= 0 ? 'Edit' : 'Add') + ' ' + {'entities':'Entity','relationships':'Relationship','memory-types':'Memory Type'}[taxonomyModalSection]"></h3>
          <button @click="taxonomyModalOpen = false"
                  class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">‚úï</button>
        </div>

        <!-- Form body -->
        <div class="p-6 space-y-5">

          <!-- Entity / Relationship / Memory Type -->
          <template x-if="taxonomyModalSection !== 'classifications-cat'">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Name <span class="text-red-500">*</span></label>
                <input type="text"
                       :value="taxonomyModalItem.name"
                       :placeholder="taxonomyModalSection === 'relationships' ? 'e.g. partners_with, manages' : 'e.g. customer, vendor'"
                       @input="const v = taxonomyNameToId($event.target.value); $event.target.value = v; taxonomyModalItem.name = v; taxonomyModalItem.id = v"
                       class="w-full px-4 py-2 font-mono text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">Lowercase letters, numbers, and underscores only</p>
              </div>
              <div x-show="taxonomyModalSection === 'relationships'">
                <label class="flex items-center gap-3 cursor-pointer px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  <input type="checkbox" x-model="taxonomyModalItem.bidirectional" class="w-4 h-4 rounded accent-blue-600 flex-shrink-0">
                  <div>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Bidirectional</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Both directions apply equally (e.g. "married_to")</p>
                  </div>
                </label>
              </div>
            </div>
          </template>

          <!-- Classification Category -->
          <template x-if="taxonomyModalSection === 'classifications-cat'">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category Name <span class="text-red-500">*</span></label>
                <input type="text"
                       x-model="taxonomyModalItem.category"
                       placeholder="e.g. Finance & Accounting"
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Classifications <span class="font-normal text-gray-400 dark:text-gray-500">(optional)</span>
                </label>
                <!-- Input field -->
                <input x-ref="clfTagInput"
                       x-model="taxonomyModalTagInput"
                       @keydown.enter.prevent="addClassificationTag()"
                       @keydown="if ($event.key === ',') { $event.preventDefault(); addClassificationTag(); }"
                       @keydown.backspace="if (!taxonomyModalTagInput && taxonomyModalItem.classifications?.length) taxonomyModalItem.classifications.pop()"
                       placeholder="Type and press Enter to add..."
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                  Press <kbd class="px-1 py-0.5 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 font-mono text-xs">Enter</kbd>
                  or <kbd class="px-1 py-0.5 rounded bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 font-mono text-xs">,</kbd>
                  to add
                </p>
                <!-- Added chips ‚Äî shown below the input once items exist -->
                <div x-show="(taxonomyModalItem.classifications || []).length > 0"
                     class="mt-3 flex flex-wrap gap-2">
                  <template x-for="(clf, i) in (taxonomyModalItem.classifications || [])" :key="i">
                    <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700">
                      <span x-text="clf.name"></span>
                      <button type="button" @click.stop="taxonomyModalItem.classifications.splice(i, 1)"
                              class="w-4 h-4 rounded-full flex items-center justify-center hover:bg-blue-200 dark:hover:bg-blue-800 text-blue-500 transition text-xs leading-none">√ó</button>
                    </span>
                  </template>
                </div>
              </div>
            </div>
          </template>

        </div>

        <!-- Footer ‚Äî matches Add New Connection exactly -->
        <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex gap-3 justify-end bg-gray-50 dark:bg-gray-800">
          <button @click="taxonomyModalOpen = false"
                  class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
            Cancel
          </button>
          <button @click="saveTaxonomyModal()" :disabled="taxonomySaving"
                  class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition disabled:opacity-50">
            <span x-show="!taxonomySaving" x-text="taxonomyModalEditIndex >= 0 ? 'Save Changes' : 'Add'"></span>
            <span x-show="taxonomySaving">Saving...</span>
          </button>
        </div>

      </div>
    </div>

    <!-- Edit Connection Settings Modal -->
    <div x-show="settingsModalOpen"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4"
         style="display: none;">
      <div class="bg-white dark:bg-gray-900 rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between items-center">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Edit Connection Settings</h3>
          <button @click="closeSettingsModal()"
                  class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl leading-none">
            ‚úï
          </button>
        </div>

        <div class="px-6 py-4 space-y-6">
          <!-- LLM Provider -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">LLM Provider</label>
            <select x-model="editingConnectionSettings.llm.provider"
                    @change="fetchAvailableModels()"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="ollama">Ollama</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
            </select>
          </div>

          <!-- Base URL (Ollama only) -->
          <div x-show="editingConnectionSettings.llm.provider === 'ollama'">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ollama Base URL</label>
            <input type="text"
                   x-model="editingConnectionSettings.llm.base_url"
                   placeholder="http://localhost:11434"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <!-- API Key (OpenAI & Anthropic only) -->
          <div x-show="editingConnectionSettings.llm.provider !== 'ollama'">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Key</label>
            <input type="password"
                   x-model="editingConnectionSettings.llm.api_key"
                   :placeholder="editingConnectionSettings.llm.provider === 'openai' ? 'sk-...' : 'sk-ant-...'"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <!-- LLM Model -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model</label>
            <div x-show="modelsLoading" class="text-sm text-gray-600 dark:text-gray-400 py-2">
              Loading available models...
            </div>
            <div x-show="modelsFetchError" class="text-sm text-red-600 dark:text-red-400 py-2" x-text="modelsFetchError">
            </div>
            <select x-show="!modelsLoading && availableModels.length > 0"
                    x-model="editingConnectionSettings.llm.model"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select a model...</option>
              <template x-for="model in availableModels" :key="model">
                <option :value="model" x-text="model"></option>
              </template>
            </select>
            <input type="text"
                   x-show="!modelsLoading && availableModels.length === 0"
                   x-model="editingConnectionSettings.llm.model"
                   placeholder="e.g., gpt-4, claude-3-sonnet, mistral"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <!-- Embedding Model (Ollama only) -->
          <div x-show="editingConnectionSettings.llm.provider === 'ollama'">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Embedding Model
              <span class="text-xs text-gray-500 ml-1">(for semantic search)</span>
            </label>
            <div x-show="modelsLoading" class="text-sm text-gray-600 dark:text-gray-400 py-2">Loading available models...</div>
            <select x-show="!modelsLoading && availableModels.length > 0"
                    x-model="editingConnectionSettings.llm.embedding_model"
                    class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 text-sm">
              <option value="">Use default (nomic-embed-text)</option>
              <template x-for="model in availableModels" :key="model">
                <option :value="model" x-text="model"></option>
              </template>
            </select>
            <input type="text"
                   x-show="!modelsLoading && availableModels.length === 0"
                   x-model="editingConnectionSettings.llm.embedding_model"
                   placeholder="e.g., nomic-embed-text"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-2 text-sm">
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
              Changing this model invalidates existing embeddings. Use Maintenance &rarr; Re-embed all after changing.
            </p>
          </div>

          <!-- Test Connection -->
          <div>
            <button @click="testLLMConnection()"
                    :disabled="!editingConnectionSettings.llm.provider || (editingConnectionSettings.llm.provider !== 'ollama' && !editingConnectionSettings.llm.api_key)"
                    class="w-full px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed font-medium">
              <span x-show="!settingsTestingConnection">üß™ Test Connection</span>
              <span x-show="settingsTestingConnection">Testing...</span>
            </button>
            <div x-show="settingsTestResult.message"
                 :class="settingsTestResult.success ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'"
                 class="mt-2 text-sm" x-text="settingsTestResult.message">
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex gap-3 justify-end bg-gray-50 dark:bg-gray-800">
          <button @click="closeSettingsModal()"
                  type="button"
                  class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
            Cancel
          </button>
          <button @click="saveConnectionSettings()"
                  type="button"
                  class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition">
            üíæ Save Settings
          </button>
        </div>
      </div>
    </div>

    <!-- Import Page -->
    <div x-show="currentView === 'import'" x-transition x-data="importApp()" x-init="init()">
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Import Knowledge Base</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-8">
        Import notes from an Obsidian vault, Notion export, or any Markdown folder.
        Each Markdown file becomes a memory with tags, domain, and relationships extracted automatically.
      </p>

      <!-- Import Type Tabs -->
      <div class="flex space-x-1 mb-6 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg w-fit">
        <button @click="importType = 'obsidian'"
                :class="importType === 'obsidian' ? 'bg-white dark:bg-gray-600 shadow text-gray-900 dark:text-white' : 'text-gray-600 dark:text-gray-400'"
                class="px-4 py-2 rounded-md text-sm font-medium transition">
          Obsidian Vault
        </button>
        <button @click="importType = 'markdown'"
                :class="importType === 'markdown' ? 'bg-white dark:bg-gray-600 shadow text-gray-900 dark:text-white' : 'text-gray-600 dark:text-gray-400'"
                class="px-4 py-2 rounded-md text-sm font-medium transition">
          Markdown Folder
        </button>
      </div>

      <!-- Import Form -->
      <div class="card-polished p-6 mb-6 hover:shadow-elevation transition-all" x-show="!jobId">
        <div class="space-y-4">

          <!-- Path Input -->
          <div>
            <label class="section-label">
              <span x-show="importType === 'obsidian'">Obsidian Vault Path</span>
              <span x-show="importType === 'markdown'">Markdown Folder Path</span>
            </label>
            <input type="text"
                   x-model="dirPath"
                   placeholder="/path/to/your/vault"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Enter the absolute server-side path to the directory containing your Markdown files.
            </p>
          </div>

          <!-- Info Box -->
          <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4 text-sm text-blue-800 dark:text-blue-300">
            <p class="font-medium mb-1">What gets imported:</p>
            <ul class="list-disc list-inside space-y-1 text-blue-700 dark:text-blue-300">
              <li>All <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">.md</code> and <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">.markdown</code> files (recursive)</li>
              <li>YAML frontmatter: tags, date, category, domain</li>
              <li>Inline <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">#hashtags</code></li>
              <li>Wiki-link relationships (<code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">[[linked note]]</code>)</li>
              <li>Directory structure mapped to domain/category</li>
            </ul>
            <p class="mt-2 text-blue-600 dark:text-blue-400">Hidden directories (e.g. <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">.obsidian</code>) are automatically skipped.</p>
          </div>

          <!-- Start Button -->
          <button @click="startImport()"
                  :disabled="!dirPath.trim() || importing"
                  class="px-6 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed font-medium">
            <span x-show="!importing">Start Import</span>
            <span x-show="importing">Starting...</span>
          </button>

          <!-- Error -->
          <div x-show="error" class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-4 text-sm text-red-800 dark:text-red-300" x-text="error"></div>
        </div>
      </div>

      <!-- Progress Section -->
      <div x-show="jobId" class="card-polished p-6 hover:shadow-elevation transition-all">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Import Progress</h3>

        <!-- Status Badge -->
        <div class="flex items-center space-x-3 mb-4">
          <span class="px-3 py-1 rounded-full text-sm font-medium"
                :class="{
                  'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200': progress.status === 'running',
                  'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200': progress.status === 'complete',
                  'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200': progress.status === 'failed'
                }"
                x-text="progress.status === 'running' ? 'Running...' : progress.status === 'complete' ? 'Complete' : 'Failed'">
          </span>
          <span class="text-sm text-gray-600 dark:text-gray-400" x-text="progress.message || ''"></span>
        </div>

        <!-- Progress Bar -->
        <div x-show="progress.files_total > 0" class="mb-4">
          <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
            <span x-text="`${progress.files_processed} of ${progress.files_total} files`"></span>
            <span x-text="`${Math.round((progress.files_processed / progress.files_total) * 100)}%`"></span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
            <div class="bg-blue-600 dark:bg-blue-500 h-3 rounded-full transition-all duration-300"
                 :style="`width: ${Math.round((progress.files_processed / progress.files_total) * 100)}%`">
            </div>
          </div>
          <p x-show="progress.current_file"
             class="mt-1 text-xs text-gray-500 dark:text-gray-400 font-mono truncate"
             x-text="'Processing: ' + progress.current_file">
          </p>
        </div>

        <!-- Result Stats -->
        <div x-show="result" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-4">
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="result && result.files_found || 0"></p>
            <p class="text-xs text-gray-500 dark:text-gray-400">Files Found</p>
          </div>
          <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 text-center">
            <p class="text-2xl font-bold text-green-700 dark:text-green-400" x-text="result && result.memories_created || 0"></p>
            <p class="text-xs text-gray-500 dark:text-gray-400">Memories Created</p>
          </div>
          <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 text-center">
            <p class="text-2xl font-bold text-blue-700 dark:text-blue-400" x-text="result && result.relationships_found || 0"></p>
            <p class="text-xs text-gray-500 dark:text-gray-400">Relationships Found</p>
          </div>
          <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-4 text-center">
            <p class="text-2xl font-bold text-yellow-700 dark:text-yellow-400" x-text="result && result.files_skipped || 0"></p>
            <p class="text-xs text-gray-500 dark:text-gray-400">Files Skipped</p>
          </div>
          <div class="bg-red-50 dark:bg-red-900/30 rounded-lg p-4 text-center">
            <p class="text-2xl font-bold text-red-700 dark:text-red-400" x-text="result && result.files_failed || 0"></p>
            <p class="text-xs text-gray-500 dark:text-gray-400">Files Failed</p>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <p class="text-2xl font-bold text-gray-700 dark:text-gray-300" x-text="result ? Math.round(result.duration_ms / 1e6) + 'ms' : '‚Äî'"></p>
            <p class="text-xs text-gray-500 dark:text-gray-400">Duration</p>
          </div>
        </div>

        <!-- Errors -->
        <div x-show="result && result.errors && result.errors.length > 0" class="mb-4">
          <details class="border border-red-200 dark:border-red-800 rounded-lg">
            <summary class="px-4 py-2 text-sm font-medium text-red-700 dark:text-red-400 cursor-pointer hover:bg-red-50 dark:hover:bg-red-900/30">
              Errors (<span x-text="result && result.errors ? result.errors.length : 0"></span>)
            </summary>
            <div class="px-4 py-2 max-h-48 overflow-y-auto bg-red-50 dark:bg-red-900/20 border-t border-red-200 dark:border-red-800">
              <template x-for="(err, i) in (result && result.errors || [])" :key="i">
                <p class="text-xs font-mono text-red-600 dark:text-red-400 py-0.5 border-b border-red-100 dark:border-red-800" x-text="err"></p>
              </template>
            </div>
          </details>
        </div>

        <!-- Actions after completion -->
        <div x-show="progress.status === 'complete' || progress.status === 'failed'" class="flex space-x-3">
          <button @click="resetForm()"
                  class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition text-sm">
            Import Another
          </button>
          <a href="/#feed"
             class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition text-sm inline-block">
            View Memories
          </a>
        </div>
      </div>
    </div>

    <!-- Entities Page -->
    <div x-show="currentView === 'entities'" x-transition>
      <div class="page-header mb-6">
        <div>
          <h2 class="page-title">üë§ Entities</h2>
          <p class="text-muted">Browse and explore all extracted entities</p>
        </div>
        <button @click="navigateTo('dashboard')" class="btn-ghost px-4 py-2 rounded-lg">
          ‚Üê Back to Dashboard
        </button>
      </div>

      <!-- Search & Filter Bar -->
      <div class="card-polished p-4 mb-6">
        <div class="flex gap-3">
          <input type="text"
                 x-model="entitySearch"
                 @input.debounce.300ms="filterEntities()"
                 placeholder="Search entities by name, type, or description..."
                 class="flex-1 px-4 py-2 rounded-lg"
                 style="background-color: var(--surface-raised); border: 1px solid var(--border-strong); color: var(--text-primary);">
          <select x-model="entityTypeFilter"
                  @change="filterEntities()"
                  class="w-48 px-3 py-2 rounded-lg"
                  style="background-color: var(--surface-raised); border: 1px solid var(--border-strong); color: var(--text-primary);">
            <option value="">All Types</option>
            <option value="person">Person</option>
            <option value="organization">Organization</option>
            <option value="tool">Tool</option>
            <option value="database">Database</option>
            <option value="concept">Concept</option>
            <option value="project">Project</option>
            <option value="skill">Skill</option>
            <option value="event">Event</option>
            <option value="location">Location</option>
            <option value="product">Product</option>
          </select>
        </div>
      </div>

      <!-- Pagination Controls -->
      <div class="flex justify-between items-center mb-4 px-2">
        <div class="text-sm text-muted">
          Showing <span x-text="filteredEntities.length"></span> of <span x-text="entityTotal"></span> entities
        </div>

        <div class="flex items-center gap-3">
          <!-- Page size selector -->
          <select x-model="entityPageSize" @change="changeEntityPageSize(entityPageSize)"
                  class="px-3 py-2 rounded-lg text-sm"
                  style="background-color: var(--surface-raised); border: 1px solid var(--border-strong); color: var(--text-primary); width: 6rem;">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>

          <!-- Page navigation -->
          <div class="flex items-center gap-2">
            <button @click="prevEntitiesPage()"
                    :disabled="entityPage === 1"
                    class="btn-ghost px-3 py-2 rounded-lg text-sm"
                    :class="entityPage === 1 ? 'opacity-40 cursor-not-allowed' : ''">
              &larr; Prev
            </button>
            <span class="text-sm text-muted">Page <span x-text="entityPage"></span></span>
            <button @click="nextEntitiesPage()"
                    :disabled="!entityHasMore"
                    class="btn-ghost px-3 py-2 rounded-lg text-sm"
                    :class="!entityHasMore ? 'opacity-40 cursor-not-allowed' : ''">
              Next &rarr;
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div x-show="entitiesLoading" class="text-center py-16">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-500 mb-4"></div>
        <p class="text-muted">Loading entities...</p>
      </div>

      <!-- Empty State -->
      <div x-show="!entitiesLoading && filteredEntities.length === 0" class="card-polished text-center py-16">
        <span class="text-5xl mb-4 block">üîç</span>
        <p class="text-muted text-lg">No entities found</p>
        <p class="text-muted text-sm mt-1" style="color: var(--text-tertiary);">Try adjusting your search or type filter</p>
      </div>

      <!-- Entity Grid -->
      <div x-show="!entitiesLoading && filteredEntities.length > 0"
           class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="entity in filteredEntities" :key="entity.id">
          <div class="card-polished p-5 hover:shadow-elevation transition-all">
            <div class="flex items-start gap-4">
              <div class="entity-avatar flex-shrink-0" x-text="getEntityIcon(entity.type)"></div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2 flex-wrap">
                  <h3 class="entity-name truncate" x-text="entity.name"></h3>
                  <span class="badge badge-info" x-text="entity.type"></span>
                </div>
                <p class="entity-subtitle mb-3" x-text="entity.description || 'No description available'"></p>
                <div class="flex flex-wrap items-center gap-3 text-xs" style="color: var(--text-tertiary);">
                  <span>Memories: <span class="badge badge-info" x-text="entity.memory_count || 0"></span></span>
                  <span x-text="formatRelationshipDate(entity.created_at)"></span>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Relationships Page -->
    <div x-show="currentView === 'relationships'" x-transition>
      <div class="page-header mb-6">
        <div>
          <h2 class="page-title">üîó Relationships</h2>
          <p class="text-muted">Browse all entity relationships</p>
        </div>
        <button @click="navigateTo('dashboard')" class="btn-ghost px-4 py-2 rounded-lg">
          ‚Üê Back to Dashboard
        </button>
      </div>

      <!-- Pagination Controls -->
      <div class="flex justify-between items-center mb-4 px-2">
        <div class="text-sm text-muted">
          Showing <span x-text="relationships.length"></span> of <span x-text="relationshipTotal"></span> relationships
        </div>

        <div class="flex items-center gap-3">
          <!-- Page size selector -->
          <select x-model="relationshipPageSize" @change="changeRelationshipPageSize(relationshipPageSize)"
                  class="px-3 py-2 rounded-lg text-sm"
                  style="background-color: var(--surface-raised); border: 1px solid var(--border-strong); color: var(--text-primary); width: 6rem;">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>

          <!-- Page navigation -->
          <div class="flex items-center gap-2">
            <button @click="prevRelationshipsPage()"
                    :disabled="relationshipPage === 1"
                    class="btn-ghost px-3 py-2 rounded-lg text-sm"
                    :class="relationshipPage === 1 ? 'opacity-40 cursor-not-allowed' : ''">
              &larr; Prev
            </button>
            <span class="text-sm text-muted">Page <span x-text="relationshipPage"></span></span>
            <button @click="nextRelationshipsPage()"
                    :disabled="!relationshipHasMore"
                    class="btn-ghost px-3 py-2 rounded-lg text-sm"
                    :class="!relationshipHasMore ? 'opacity-40 cursor-not-allowed' : ''">
              Next &rarr;
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div x-show="relationshipsLoading" class="text-center py-16">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-500 mb-4"></div>
        <p class="text-muted">Loading relationships...</p>
      </div>

      <!-- Empty State -->
      <div x-show="!relationshipsLoading && relationships.length === 0" class="card-polished text-center py-16">
        <span class="text-5xl mb-4 block">üîç</span>
        <p class="text-muted text-lg">No relationships found</p>
        <p class="text-sm mt-1" style="color: var(--text-tertiary);">Create relationships between entities to see them here</p>
      </div>

      <!-- Relationships List -->
      <div x-show="!relationshipsLoading && relationships.length > 0" class="card-polished overflow-hidden">
        <template x-for="rel in relationships" :key="rel.id || `${rel.source_name}-${rel.type}-${rel.target_name}`">
          <div class="relationship-item">
            <!-- Source Entity (220px) -->
            <div class="flex items-center gap-3 min-w-0">
              <span class="text-2xl flex-shrink-0" x-text="getEntityIcon(rel.source_type)"></span>
              <div class="min-w-0 flex-1">
                <p class="text-sm font-semibold truncate" style="color: var(--text-primary);" x-text="rel.source_name"></p>
                <span class="badge badge-info text-xs mt-1" x-text="rel.source_type"></span>
              </div>
            </div>

            <!-- Relationship Type Pill (160px, centered) -->
            <div class="flex justify-center">
              <span class="relationship-type-pill" x-text="rel.type"></span>
            </div>

            <!-- Arrow (50px, centered) -->
            <div class="flex justify-center text-lg" style="color: var(--text-tertiary);">‚Üí</div>

            <!-- Target Entity (220px) -->
            <div class="flex items-center gap-3 min-w-0">
              <span class="text-2xl flex-shrink-0" x-text="getEntityIcon(rel.target_type)"></span>
              <div class="min-w-0 flex-1">
                <p class="text-sm font-semibold truncate" style="color: var(--text-primary);" x-text="rel.target_name"></p>
                <span class="badge badge-info text-xs mt-1" x-text="rel.target_type"></span>
              </div>
            </div>

            <!-- Progress Bar + Percentage (160px, right-aligned) -->
            <div class="flex items-center gap-2 justify-end min-w-0">
              <div x-show="rel.weight || rel.confidence" class="hidden md:flex items-center gap-2 flex-1 justify-end">
                <div class="flex-1 rounded-full h-2 overflow-hidden" style="background-color: var(--surface-inset);">
                  <div class="relationship-progress-bar" :style="`width: ${(rel.weight || rel.confidence || 0) * 100}%`"></div>
                </div>
                <span class="text-xs font-semibold flex-shrink-0 w-10 text-right" style="color: var(--text-secondary);"
                      x-text="`${Math.round((rel.weight || rel.confidence || 0) * 100)}%`"></span>
              </div>
            </div>

            <!-- Date (130px, right-aligned) -->
            <div class="flex justify-end">
              <span class="text-xs whitespace-nowrap" style="color: var(--text-tertiary);"
                    x-text="formatRelationshipDate(rel.created_at || rel.updated_at)"></span>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Queue Page -->
    <div x-show="currentView === 'queue'" x-transition>
      <!-- Page Header -->
      <div class="page-header mb-6">
        <div>
          <h2 class="page-title">‚è≥ Enrichment Queue</h2>
          <p class="text-muted">Monitor memory enrichment processing activity</p>
        </div>
        <div class="flex items-center gap-3">
          <button @click="loadQueue()"
                  :disabled="queueLoading"
                  class="btn-ghost px-4 py-2 rounded-lg text-sm"
                  :class="queueLoading ? 'opacity-50 cursor-not-allowed' : ''">
            <span x-show="!queueLoading">‚Üª Refresh</span>
            <span x-show="queueLoading">Refreshing...</span>
          </button>
          <button @click="navigateTo('dashboard')" class="btn-ghost px-4 py-2 rounded-lg">
            &larr; Back
          </button>
        </div>
      </div>

      <!-- Queue Stats Grid -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
        <!-- Live Channel Depth -->
        <div class="card-polished p-5 text-center">
          <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--text-tertiary);">Channel Depth</p>
          <p class="text-3xl font-bold" style="color: var(--text-primary);" x-text="queueStats.channel_depth || 0"></p>
          <p class="text-xs mt-1" style="color: var(--text-tertiary);">live buffer</p>
        </div>

        <!-- Pending -->
        <div class="card-polished p-5 text-center">
          <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--text-tertiary);">Pending</p>
          <p class="text-3xl font-bold text-yellow-500 dark:text-yellow-400" x-text="queueStats.pending || 0"></p>
          <p class="text-xs mt-1" style="color: var(--text-tertiary);">awaiting LLM</p>
        </div>

        <!-- Processing -->
        <div class="card-polished p-5 text-center">
          <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--text-tertiary);">Processing</p>
          <p class="text-3xl font-bold text-blue-500 dark:text-blue-400" x-text="queueStats.processing || 0"></p>
          <p class="text-xs mt-1" style="color: var(--text-tertiary);">in progress</p>
        </div>

        <!-- Enriched (total) -->
        <div class="card-polished p-5 text-center">
          <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--text-tertiary);">Total Enriched</p>
          <p class="text-3xl font-bold text-green-500 dark:text-green-400" x-text="queueStats.enriched || 0"></p>
          <p class="text-xs mt-1" style="color: var(--text-tertiary);">all time</p>
        </div>

        <!-- Completed Today -->
        <div class="card-polished p-5 text-center">
          <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--text-tertiary);">Completed Today</p>
          <p class="text-3xl font-bold text-cyan-500 dark:text-cyan-400" x-text="queueStats.completed_today || 0"></p>
          <p class="text-xs mt-1" style="color: var(--text-tertiary);">since midnight UTC</p>
        </div>

        <!-- Failed -->
        <div class="card-polished p-5 text-center">
          <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--text-tertiary);">Failed</p>
          <p class="text-3xl font-bold text-red-500 dark:text-red-400" x-text="queueStats.failed || 0"></p>
          <p class="text-xs mt-1" style="color: var(--text-tertiary);">needs attention</p>
        </div>
      </div>

      <!-- Note about queue behaviour -->
      <div x-show="(queueStats.pending || 0) === 0 && (queueStats.processing || 0) === 0 && !queueLoading"
           class="card-polished p-4 mb-6 flex items-start gap-3"
           style="border-left: 3px solid var(--color-success, #10b981);">
        <span class="text-2xl">‚ú®</span>
        <div>
          <p class="font-semibold" style="color: var(--text-primary);">Queue is clear</p>
          <p class="text-sm mt-1" style="color: var(--text-secondary);">
            All memories are enriched. The enrichment worker processes jobs in near real-time (seconds per memory),
            so the queue is usually empty unless a large batch was just imported or Ollama is unavailable.
            Check <strong>Total Enriched</strong> and <strong>Completed Today</strong> for activity history.
          </p>
        </div>
      </div>

      <!-- Loading indicator -->
      <div x-show="queueLoading" class="text-center py-10">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500 mb-3"></div>
        <p class="text-muted text-sm">Loading queue...</p>
      </div>

      <!-- Pending / Processing Items -->
      <div x-show="!queueLoading && queueItems.length > 0">
        <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Active Items</h3>
        <div class="space-y-3">
          <template x-for="item in queueItems" :key="item.id">
            <div class="card-polished p-4">
              <div class="flex justify-between items-start mb-2">
                <div class="flex items-center gap-2">
                  <span class="badge"
                        :class="item.status === 'processing' ? 'badge-info' : 'badge-warning'"
                        x-text="item.status"></span>
                  <span class="text-xs font-mono" style="color: var(--text-tertiary);" x-text="item.id"></span>
                </div>
                <span class="text-xs" style="color: var(--text-tertiary);"
                      x-text="new Date(item.created_at).toLocaleString()"></span>
              </div>

              <p class="text-sm mb-3" style="color: var(--text-secondary);" x-text="item.content"></p>

              <div class="flex flex-wrap gap-4 text-xs" style="color: var(--text-tertiary);">
                <span>Attempts: <strong x-text="item.enrichment_attempts || 0"></strong></span>
                <span x-show="item.enrichment_error">
                  Error: <span class="text-red-400" x-text="item.enrichment_error"></span>
                </span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
    <!-- End Queue Page -->
  </main>

  <!-- Toast Notifications (Bottom Right) -->
  <div class="fixed bottom-4 right-4 space-y-3 z-50">
    <template x-for="notification in notifications" :key="notification.id">
      <div class="rounded-lg shadow-lg backdrop-blur-sm p-4 max-w-sm flex items-start space-x-3 border-l-4"
           :style="{
             'background-color': 'var(--surface-raised)',
             'border-color': notification.type === 'success' ? '#10b981' : notification.type === 'error' ? '#ef4444' : notification.type === 'warning' ? '#f59e0b' : '#3b82f6',
             'color': 'var(--text-primary)'
           }">
        <div class="flex-1">
          <p class="text-sm text-gray-900 dark:text-white" x-text="notification.message"></p>
        </div>
        <button @click="removeNotification(notification.id)"
                class="text-gray-400 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
          ‚úï
        </button>
      </div>
    </template>
  </div>

  <!-- Add Connection Modal - Stepper Wizard -->
  <div x-show="addConnectionModalOpen"
       class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4"
       style="display: none;"
       @click.self="closeAddConnectionModal()">
    <div class="bg-white/95 dark:bg-gray-800/95 rounded-lg shadow-lg backdrop-blur-sm max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/20 dark:border-gray-700/30">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm border-b border-gray-200/50 dark:border-gray-700/50 p-6 flex justify-between items-center">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Add New Connection</h3>
        <button @click="closeAddConnectionModal()"
                class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
          ‚úï
        </button>
      </div>

      <!-- Step Indicators -->
      <div class="px-6 pt-6 pb-4">
        <div class="flex items-center justify-between">
          <div class="flex flex-col items-center" :class="connectionWizardStep >= 1 ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400'">
            <div class="w-10 h-10 rounded-full flex items-center justify-center" :class="connectionWizardStep >= 1 ? 'bg-blue-600 text-white' : 'bg-gray-300 dark:bg-gray-700 text-gray-600'">
              1
            </div>
            <span class="text-xs mt-1 text-center">Database</span>
          </div>
          <div class="flex-1 h-1 mx-2 -mt-6" :class="connectionWizardStep >= 2 ? 'bg-blue-600 dark:bg-blue-400' : 'bg-gray-300 dark:bg-gray-700'"></div>
          <div class="flex flex-col items-center" :class="connectionWizardStep >= 2 ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400'">
            <div class="w-10 h-10 rounded-full flex items-center justify-center" :class="connectionWizardStep >= 2 ? 'bg-blue-600 text-white' : 'bg-gray-300 dark:bg-gray-700 text-gray-600'">
              2
            </div>
            <span class="text-xs mt-1 text-center">LLM</span>
          </div>
          <div class="flex-1 h-1 mx-2 -mt-6" :class="connectionWizardStep >= 3 ? 'bg-blue-600 dark:bg-blue-400' : 'bg-gray-300 dark:bg-gray-700'"></div>
          <div class="flex flex-col items-center" :class="connectionWizardStep >= 3 ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400'">
            <div class="w-10 h-10 rounded-full flex items-center justify-center" :class="connectionWizardStep >= 3 ? 'bg-blue-600 text-white' : 'bg-gray-300 dark:bg-gray-700 text-gray-600'">
              3
            </div>
            <span class="text-xs mt-1 text-center">User Name</span>
          </div>
        </div>
      </div>

      <!-- Form Content -->
      <div class="p-6 space-y-5 min-h-[300px]">
        <!-- Step 1: Database -->
        <div x-show="connectionWizardStep === 1" class="space-y-4">
          <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Database Configuration</h4>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Connection ID</label>
            <input type="text" x-model="newConnection.name" required placeholder="e.g., dev, production, test"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Display Name</label>
            <input type="text" x-model="newConnection.display_name" required placeholder="e.g., Development Environment"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
            <textarea x-model="newConnection.description" rows="2" placeholder="Describe this connection..."
                      class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Database Type</label>
            <select x-model="newConnection.database.type" required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="sqlite">SQLite (Local File)</option>
              <option value="postgresql">PostgreSQL</option>
            </select>
          </div>

          <div x-show="newConnection.database.type === 'sqlite'">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Database Path</label>
            <input type="text" x-model="newConnection.database.path" required placeholder="./data/my-connection.db"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div x-show="newConnection.database.type === 'postgresql'" class="space-y-3">
            <input type="text" x-model="newConnection.database.host" required placeholder="Host (e.g., localhost)"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="number" x-model.number="newConnection.database.port" required placeholder="Port (e.g., 5432)"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="text" x-model="newConnection.database.username" placeholder="Username (e.g., postgres)"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="password" x-model="newConnection.database.password" placeholder="Password"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="text" x-model="newConnection.database.database" required placeholder="Database name"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>

        <!-- Step 2: LLM -->
        <div x-show="connectionWizardStep === 2" class="space-y-4">
          <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">LLM Configuration</h4>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">LLM Provider</label>
            <select x-model="newConnection.llm.provider" required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="ollama">Ollama (Local)</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
            </select>
          </div>

          <div x-show="newConnection.llm.provider === 'ollama'" class="space-y-3">
            <input type="text" x-model="newConnection.llm.base_url" placeholder="http://localhost:11434"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="text" x-model="newConnection.llm.model" required placeholder="e.g., qwen2.5:7b"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div x-show="newConnection.llm.provider === 'openai'" class="space-y-3">
            <input type="password" x-model="newConnection.llm.api_key" required placeholder="sk-..."
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="text" x-model="newConnection.llm.model" required placeholder="e.g., gpt-4"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div x-show="newConnection.llm.provider === 'anthropic'" class="space-y-3">
            <input type="password" x-model="newConnection.llm.api_key" required placeholder="sk-ant-..."
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="text" x-model="newConnection.llm.model" required placeholder="e.g., claude-opus-4-1"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>

        <!-- Step 3: User Name -->
        <div x-show="connectionWizardStep === 3" class="space-y-4">
          <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">User Name for Memories</h4>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">This name will be attached to memories created in this connection</p>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">User Name</label>
            <input type="text" x-model="connectionWizardUserName" required placeholder="e.g., MJ Bonanno"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>
      </div>

      <!-- Footer Buttons -->
      <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex gap-3 justify-between bg-gray-50 dark:bg-gray-800">
        <button @click="closeAddConnectionModal()"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
          Cancel
        </button>
        <div class="flex gap-3">
          <button @click="connectionWizardStep = connectionWizardStep - 1" 
                  x-show="connectionWizardStep > 1"
                  class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
            ‚Üê Back
          </button>
          <button @click="nextWizardStep()" 
                  x-show="connectionWizardStep < 3"
                  class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition">
            Next ‚Üí
          </button>
          <button @click="finishWizard()" 
                  x-show="connectionWizardStep === 3"
                  :disabled="connectionCreating"
                  type="button"
                  class="px-4 py-2 bg-green-600 dark:bg-green-700 text-white rounded-lg hover:bg-green-700 dark:hover:bg-green-600 transition disabled:opacity-50">
            <span x-show="!connectionCreating">‚úì Create Connection</span>
            <span x-show="connectionCreating">Creating...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Define Alpine components before Alpine auto-initializes -->
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('mementoApp', () => ({
        // Navigation
        currentView: 'dashboard',
        currentMemoryId: null,

        // Theme
        isDarkMode: true,

        // Search state
        searchQuery: '',
        searchResults: [],
        searchLoading: false,
        searchPage: 1,
        searchPageSize: 20,
        searchTotal: 0,
        searchHasMore: false,

        // Feed state
        feedResults: [],
        feedLoading: false,

        // Stats
        stats: { memories: 0, entities: 0, relationships: 0, queueSize: 0 },
        statsLoading: false,

        // Activity chart
        activityRange: '24hour',
        activityData: [],
        activityChart: null,
        activityLoading: false,
        activityEmpty: false,

        // Queue monitoring
        queueStats: { channel_depth: 0, pending: 0, processing: 0, enriched: 0, failed: 0, completed_today: 0 },
        queueItems: [],
        queueLoading: false,

        // Config & System Info
        config: {},
        systemInfo: { workersRunning: true },
        userConfig: { userName: '' },
        userConfigOriginal: { userName: '' }, // Keep track of original for reset
        userConfigModalOpen: false,
        editingUserConfig: { userName: '' },

        // WebSocket
        wsConnected: false,
        ws: null,
        reconnectAttempts: 0,
        liveFeedPaused: false,
        statsReloadPending: false,

        // Notifications
        notifications: [],
        notificationId: 0,

        // Auto-refresh interval
        statsRefreshInterval: null,

        // Connection state
        connections: [],          // Available connections (loaded from API)
        activeConnection: null,   // Currently selected connection name

        // Connection management (settings page)
        connectionsLoading: false,
        connectionsLoaded: false,
        defaultConnection: null,
        connectionEditMode: false,
        connectionCreating: false,
        connectionTesting: false,
        connectionTestResult: { message: '', success: false },
        addConnectionModalOpen: false,
        newConnection: {
          name: '',
          display_name: '',
          description: '',
          database: { type: 'sqlite', path: '', host: '', port: 5432, username: '', password: '', database: '' },
          llm: { provider: 'ollama', model: '', api_key: '', base_url: 'http://localhost:11434' },
          category_template: '',
          categories: []
        },
        connectionWizardStep: 1,
        connectionWizardUserName: '',

        // Connection settings modal
        settingsModalOpen: false,
        editingConnectionSettings: {
          llm: { provider: 'ollama', model: '', api_key: '', base_url: 'http://localhost:11434', embedding_model: '' }
        },
        availableModels: [],
        modelsLoading: false,
        modelsFetchError: '',
        settingsTestingConnection: false,
        settingsTestResult: { message: '', success: false },

        // Taxonomy settings
        taxonomySettings: null,
        taxonomyLoading: false,
        taxonomySaving: false,
        taxonomyActiveTab: 'entities',  // 'entities', 'relationships', 'memory-types', 'classifications'
        taxonomySaveError: '',
        taxonomySaveSuccess: '',

        // Taxonomy item modal
        taxonomyModalOpen: false,
        taxonomyModalSection: '',   // 'entities' | 'relationships' | 'memory-types' | 'classifications-cat' | 'classifications-item'
        taxonomyModalEditIndex: -1, // -1 = new, >=0 = editing existing
        taxonomyModalCatIndex: -1,  // for classifications-item only
        taxonomyModalItem: {},      // the item being edited in the modal

        // Editing state - arrays of objects being edited
        editingEntityTypes: [],      // [{id, name, description}]
        editingRelTypes: [],         // [{id, name, description, bidirectional, keywords_str}]
        editingMemoryTypes: [],      // [{id, name, description, keywords_str}]
        editingClassifications: [],  // [{category, description, is_system, classifications: [{id, name, description, keywords_str, icon}]}]
        selectedClassificationCategory: '',  // active category for enrichment
        taxonomyModalTagInput: '',           // current text in the classification tag input

        async init() {
          this.initTheme();
          this.connectWebSocket();
          await this.loadConnections();
          await this.loadUserConfig();
          this.handleRouting();

          // Only load data needed for the current view ‚Äî not everything at once
          if (this.currentView === 'dashboard') {
            this.loadStats();
            this.loadActivity();
          } else if (this.currentView === 'feed') {
            this.loadFeed();
          } else if (this.currentView === 'search') {
            this.searchPage = 1;
            this.performSearch();
          } else if (this.currentView === 'entities') {
            this.loadEntities();
          } else if (this.currentView === 'relationships') {
            this.loadRelationships();
          } else if (this.currentView === 'settings') {
            this.loadConfig();
            this.loadTaxonomySettings();
          } else if (this.currentView === 'queue') {
            this.loadQueue();
          }

          // Stats update via WebSocket events only (no polling)
          // this.statsRefreshInterval = setInterval(() => this.loadStats(), 5000);
        },

        // Theme toggle
        // Dark mode: html.dark class activates Tailwind dark: variants
        // Light mode: html.light class activates CSS variable overrides in theme.css
        initTheme() {
          const theme = localStorage.getItem('theme');
          this.isDarkMode = theme !== 'light';
          if (theme === 'light') {
            document.documentElement.classList.add('light');
            document.documentElement.classList.remove('dark');
          } else {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
          }
        },

        toggleTheme() {
          this.isDarkMode = !this.isDarkMode;
          if (this.isDarkMode) {
            // Switch to dark mode: add 'dark', remove 'light'
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
            localStorage.setItem('theme', 'dark');
          } else {
            // Switch to light mode: add 'light', remove 'dark'
            document.documentElement.classList.add('light');
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
          }
          // Re-render activity chart with new theme colors
          if (this.activityChart) {
            this.activityChart.destroy();
            this.activityChart = null;
          }
          this.$nextTick(() => this.renderActivityChart({ points: this.activityData }));
        },

        // Navigation
        navigateTo(view) {
          if (view === this.currentView) return; // Already on this view; no duplicate loads

          this.currentView = view;
          this.currentMemoryId = null;
          window.location.hash = view;

          // Load data only when navigating TO a view, and only if not already loaded
          if (view === 'dashboard') {
            if (!this.stats.memories && !this.statsLoading) this.loadStats();
            if (!this.activityLoading) this.loadActivity();
          } else if (view === 'feed') {
            if (this.feedResults.length === 0 && !this.feedLoading) this.loadFeed();
          } else if (view === 'settings') {
            this.loadConfig();
            this.refreshConnections();
            this.loadTaxonomySettings();
          } else if (view === 'entities') {
            this.loadEntities();
          } else if (view === 'relationships') {
            this.loadRelationships();
          } else if (view === 'queue') {
            this.loadQueue();
          } else if (view === 'search') {
            // Only load if not already loading or if we're switching tabs
            if (this.searchResults.length === 0 && !this.searchLoading) {
              this.searchPage = 1;
              this.performSearch();
            }
          }
        },

        handleRouting() {
          const hash = window.location.hash.slice(1);
          if (hash && ['dashboard', 'feed', 'search', 'graph', 'settings', 'debug', 'import', 'entities', 'relationships', 'queue'].includes(hash)) {
            this.currentView = hash;
            // Data loading is handled by init() after handleRouting() returns
          } else {
            this.currentView = 'dashboard';
          }
        },

        // WebSocket
        connectWebSocket() {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/ws`;

          this.ws = new WebSocket(wsUrl);

          this.ws.onopen = () => {
            this.wsConnected = true;
            this.reconnectAttempts = 0;
            this.showNotification('Connected to server', 'success');
          };

          this.ws.onclose = () => {
            this.wsConnected = false;
            this.reconnectWithBackoff();
          };

          this.ws.onerror = () => {
            this.wsConnected = false;
          };

          this.ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleWebSocketMessage(data);
          };
        },

        reconnectWithBackoff() {
          const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
          this.reconnectAttempts++;
          setTimeout(() => this.connectWebSocket(), delay);
        },

        handleWebSocketMessage(data) {
          // Debounce stats/activity reloads: coalesce rapid events into a single fetch
          if (data.type === 'memory_created' || data.type === 'memory_updated' ||
              data.type === 'memory_deleted' || data.type === 'enrichment_complete') {
            if (!this.statsReloadPending) {
              this.statsReloadPending = true;
              setTimeout(() => {
                // Only reload dashboard data if the user is currently on the dashboard
                if (this.currentView === 'dashboard') {
                  this.loadStats();
                  this.loadActivity();
                }
                this.statsReloadPending = false;
              }, 1000);
            }
          }

          // Skip live feed updates if paused
          if (this.liveFeedPaused) return;

          if (data.type === 'memory_created') {
            this.showNotification(`New memory created: ${data.memoryId}`, 'success');
            // Reload the feed if we're on feed page
            if (this.currentView === 'feed') {
              this.loadFeed();
            }
          } else if (data.type === 'memory_updated') {
            this.showNotification(`Memory updated: ${data.memoryId}`, 'info');
            if (this.currentView === 'feed') {
              this.loadFeed();
            }
          } else if (data.type === 'memory_deleted') {
            this.showNotification(`Memory deleted: ${data.memoryId}`, 'warning');
            if (this.currentView === 'feed') {
              this.loadFeed();
            }
          } else if (data.type === 'enrichment_complete') {
            this.showNotification(`Memory enriched: ${data.memoryId}`, 'success');
            // Refresh queue page if it's currently visible
            if (this.currentView === 'queue') {
              this.loadQueue();
            }
          }
        },

        toggleLiveFeed() {
          this.liveFeedPaused = !this.liveFeedPaused;
          const status = this.liveFeedPaused ? 'paused' : 'resumed';
          this.showNotification(`Live feed ${status}`, 'info');
        },

        // API calls
        async apiCall(url, options = {}) {
          try {
            const response = await fetch(url, {
              ...options,
              headers: { 'Content-Type': 'application/json', ...options.headers }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
          } catch (error) {
            this.showNotification(`Error: ${error.message}`, 'error');
            throw error;
          }
        },

        // ‚îÄ‚îÄ‚îÄ Connection Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // Build headers for the active connection
        connectionHeaders() {
          const headers = { 'Content-Type': 'application/json' };
          if (this.activeConnection) {
            headers['X-Connection-ID'] = this.activeConnection;
          }
          return headers;
        },

        async loadConnections() {
          if (this.connectionsLoaded || this.connectionsLoading) return; // Prevent duplicate calls
          this.connectionsLoading = true;
          try {
            const response = await fetch('/api/connections');
            const data = await response.json();
            this.connections = data.connections || [];
            this.defaultConnection = data.default_connection || null;

            // Restore saved connection or fall back to default
            const saved = localStorage.getItem('activeConnection');
            if (saved && this.connections.find(c => c.name === saved)) {
              this.activeConnection = saved;
            } else if (this.defaultConnection && this.connections.find(c => c.name === this.defaultConnection)) {
              this.activeConnection = this.defaultConnection;
            } else if (this.connections.length > 0) {
              this.activeConnection = this.connections[0].name;
            }
            this.connectionsLoaded = true;
          } catch (error) {
            console.error('Failed to load connections:', error);
          } finally {
            this.connectionsLoading = false;
          }
        },

        async switchConnection() {
          console.log('Switching to connection:', this.activeConnection);
          if (!this.activeConnection) return;
          localStorage.setItem('activeConnection', this.activeConnection);

          // Reload current page data with new connection
          console.log('Current view:', this.currentView);
          if (this.currentView === 'dashboard') {
            await this.loadStats();
          } else if (this.currentView === 'feed') {
            await this.loadFeed();
          } else if (this.currentView === 'entities') {
            await this.loadEntities();
          } else if (this.currentView === 'relationships') {
            await this.loadRelationships();
          } else if (this.currentView === 'search') {
            await this.performSearch();
          } else if (this.currentView === 'queue') {
            await this.loadQueue();
          }

          this.showNotification(`Switched to ${this.getConnectionName()}`, 'success');
        },

        getConnectionName() {
          const conn = this.connections.find(c => c.name === this.activeConnection);
          return conn ? (conn.display_name || conn.name) : 'Unknown';
        },

        getActiveConnectionData() {
          return this.connections.find(c => c.name === this.activeConnection) || null;
        },

        // Settings page: reload connection list (used after add/edit/delete)
        async refreshConnections() {
          this.connectionsLoading = true;
          try {
            const response = await fetch('/api/connections');
            const data = await response.json();
            this.connections = data.connections || [];
            this.defaultConnection = data.default_connection || null;
          } catch (error) {
            console.error('Failed to refresh connections:', error);
          } finally {
            this.connectionsLoading = false;
          }
        },

        openAddConnectionModal(conn = null) {
          if (conn) {
            // Edit mode
            this.connectionEditMode = true;
            this.newConnection = {
              name: conn.name,
              display_name: conn.display_name || '',
              description: conn.description || '',
              database: {
                type: conn.database?.type || 'sqlite',
                path: conn.database?.path || '',
                host: conn.database?.host || '',
                port: conn.database?.port || 5432,
                username: conn.database?.username || '',
                password: conn.database?.password || '',
                database: conn.database?.database || '',
              },
              llm: {
                provider: conn.llm?.provider || 'ollama',
                model: conn.llm?.model || '',
                api_key: conn.llm?.api_key || '',
                base_url: conn.llm?.base_url || 'http://localhost:11434',
              },
              category_template: conn.category_template || '',
              categories: conn.categories || [],
            };
          } else {
            // Add mode
            this.connectionEditMode = false;
            this.newConnection = {
              name: '',
              display_name: '',
              description: '',
              database: { type: 'sqlite', path: '', host: '', port: 5432, username: '', password: '', database: '' },
              llm: { provider: 'ollama', model: '', api_key: '', base_url: 'http://localhost:11434' },
              category_template: '',
              categories: [],
            };
          }
          this.addConnectionModalOpen = true;
        },

        closeAddConnectionModal() {
          this.addConnectionModalOpen = false;
          this.connectionEditMode = false;
          this.connectionCreating = false;
          this.connectionTesting = false;
          this.connectionTestResult = { message: '', success: false };
          this.connectionWizardStep = 1;
          this.connectionWizardUserName = '';
          // Reset form data
          this.newConnection = {
            name: '',
            display_name: '',
            description: '',
            database: { type: 'sqlite', path: '', host: '', port: 5432, username: '', password: '', database: '' },
            llm: { provider: 'ollama', model: '', api_key: '', base_url: 'http://localhost:11434' },
            category_template: '',
            categories: []
          };
        },

        async testConnectionConfig() {
          this.connectionTesting = true;
          this.connectionTestResult = { message: '', success: false };
          try {
            const response = await fetch('/api/connections/test', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.newConnection),
            });
            const data = await response.json();
            if (response.ok && data.success) {
              this.connectionTestResult = { message: '‚úì Connection successful!', success: true };
            } else {
              this.connectionTestResult = { message: `‚úó ${data.error || 'Connection failed'}`, success: false };
            }
          } catch (error) {
            this.connectionTestResult = { message: `‚úó Error: ${error.message}`, success: false };
          } finally {
            this.connectionTesting = false;
          }
        },

        editConnectionSettings() {
          const activeConn = this.getActiveConnectionData();
          if (activeConn) {
            this.editingConnectionSettings = {
              llm: {
                provider: activeConn.llm?.provider || 'ollama',
                model: activeConn.llm?.model || '',
                api_key: activeConn.llm?.api_key || '',
                base_url: activeConn.llm?.base_url || 'http://localhost:11434',
                embedding_model: activeConn.llm?.embedding_model || '',
              }
            };
            this.settingsModalOpen = true;
            this.availableModels = [];
            this.modelsFetchError = '';
            this.settingsTestResult = { message: '', success: false };
            // Fetch models for the current provider
            this.fetchAvailableModels();
          }
        },

        closeSettingsModal() {
          this.settingsModalOpen = false;
          this.editingConnectionSettings = {
            llm: { provider: 'ollama', model: '', api_key: '', base_url: 'http://localhost:11434', embedding_model: '' }
          };
          this.availableModels = [];
          this.modelsFetchError = '';
          this.settingsTestResult = { message: '', success: false };
        },

        async saveConnectionSettings() {
          const activeConn = this.getActiveConnectionData();
          if (!activeConn) return;

          try {
            // Merge the new settings into the connection
            const updatedConnection = {
              ...activeConn,
              llm: this.editingConnectionSettings.llm
            };

            const response = await fetch(`/api/connections/${encodeURIComponent(activeConn.name)}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(updatedConnection),
            });

            if (!response.ok) {
              const err = await response.json().catch(() => ({}));
              throw new Error(err.error || `HTTP ${response.status}`);
            }

            this.showNotification('Connection settings updated', 'success');
            this.closeSettingsModal();
            await this.refreshConnections();
          } catch (error) {
            this.showNotification(`Failed to update settings: ${error.message}`, 'error');
          }
        },

        async fetchAvailableModels() {
          this.modelsLoading = true;
          this.modelsFetchError = '';
          this.availableModels = [];

          try {
            const params = new URLSearchParams({
              provider: this.editingConnectionSettings.llm.provider
            });

            if (this.editingConnectionSettings.llm.provider !== 'ollama') {
              params.append('api_key', this.editingConnectionSettings.llm.api_key);
            } else if (this.editingConnectionSettings.llm.base_url) {
              params.append('base_url', this.editingConnectionSettings.llm.base_url);
            }

            const response = await fetch(`/api/llm/available-models?${params}`, {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
              const err = await response.json().catch(() => ({}));
              throw new Error(err.error || `HTTP ${response.status}`);
            }

            const data = await response.json();
            if (data.models && Array.isArray(data.models)) {
              this.availableModels = data.models;
            }

            if (data.error) {
              this.modelsFetchError = `Warning: ${data.error}`;
            }
          } catch (error) {
            this.modelsFetchError = `Failed to load models: ${error.message}`;
            this.availableModels = [];
          } finally {
            this.modelsLoading = false;
          }
        },

        async testLLMConnection() {
          this.settingsTestingConnection = true;
          this.settingsTestResult = { message: '', success: false };

          try {
            const payload = {
              provider: this.editingConnectionSettings.llm.provider,
              model: this.editingConnectionSettings.llm.model
            };

            if (this.editingConnectionSettings.llm.provider !== 'ollama') {
              payload.api_key = this.editingConnectionSettings.llm.api_key;
            }
            if (this.editingConnectionSettings.llm.base_url) {
              payload.base_url = this.editingConnectionSettings.llm.base_url;
            }

            const response = await fetch('/api/llm/test-connection', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!response.ok) {
              const err = await response.json().catch(() => ({}));
              throw new Error(err.error || `HTTP ${response.status}`);
            }

            const data = await response.json();
            if (data.success) {
              this.settingsTestResult = {
                message: `‚úì Connected successfully! Found ${data.available_models?.length || 0} models.`,
                success: true
              };
            } else {
              this.settingsTestResult = {
                message: `‚úó Connection failed: ${data.error}`,
                success: false
              };
            }
          } catch (error) {
            this.settingsTestResult = {
              message: `‚úó Error: ${error.message}`,
              success: false
            };
          } finally {
            this.settingsTestingConnection = false;
          }
        },

        nextWizardStep() {
          // Validate current step before moving forward
          if (this.connectionWizardStep === 1) {
            if (!this.newConnection.name || !this.newConnection.display_name || !this.newConnection.database.type) {
              this.showNotification('Please fill in all required database fields', 'error');
              return;
            }
            if (this.newConnection.database.type === 'sqlite' && !this.newConnection.database.path) {
              this.showNotification('Please enter the SQLite database path', 'error');
              return;
            }
            if (this.newConnection.database.type === 'postgresql' &&
                (!this.newConnection.database.host || !this.newConnection.database.port || !this.newConnection.database.database)) {
              this.showNotification('Please fill in all PostgreSQL connection details', 'error');
              return;
            }
          } else if (this.connectionWizardStep === 2) {
            if (!this.newConnection.llm.provider || !this.newConnection.llm.model) {
              this.showNotification('Please select a provider and model', 'error');
              return;
            }
            if ((this.newConnection.llm.provider === 'openai' || this.newConnection.llm.provider === 'anthropic')
                && !this.newConnection.llm.api_key) {
              this.showNotification('Please enter your API key', 'error');
              return;
            }
          }
          this.connectionWizardStep++;
        },

        finishWizard() {
          if (!this.connectionWizardUserName) {
            this.showNotification('Please enter a user name', 'error');
            return;
          }
          // Save user name to the connection (could be stored elsewhere if needed)
          // For now, we'll just proceed with creating the connection
          this.createConnection();
        },

        async createConnection() {
          this.connectionCreating = true;
          try {
            const method = this.connectionEditMode ? 'PUT' : 'POST';
            const url = this.connectionEditMode
              ? `/api/connections/${encodeURIComponent(this.newConnection.name)}`
              : '/api/connections';

            const response = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.newConnection),
            });

            if (!response.ok) {
              const err = await response.json().catch(() => ({}));
              throw new Error(err.error || `HTTP ${response.status}`);
            }

            this.showNotification(
              this.connectionEditMode ? 'Connection updated' : 'Connection created',
              'success'
            );
            this.closeAddConnectionModal();
            await this.refreshConnections();
          } catch (error) {
            this.showNotification(`Failed: ${error.message}`, 'error');
          } finally {
            this.connectionCreating = false;
          }
        },

        async setDefaultConnection(name) {
          try {
            const response = await fetch('/api/connections/default', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name }),
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            this.defaultConnection = name;
            this.activeConnection = name;
            localStorage.setItem('activeConnection', name);
            this.showNotification(`Default connection set to ${name}`, 'success');
            await this.refreshConnections();
          } catch (error) {
            this.showNotification(`Failed to set default: ${error.message}`, 'error');
          }
        },

        async deleteConnection(name) {
          if (!confirm(`Delete connection "${name}"? This cannot be undone.`)) return;
          try {
            const response = await fetch(`/api/connections/${encodeURIComponent(name)}`, {
              method: 'DELETE',
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            this.showNotification(`Connection "${name}" deleted`, 'success');
            if (this.activeConnection === name) {
              this.activeConnection = null;
            }
            await this.refreshConnections();
            // Re-resolve active connection
            if (!this.activeConnection && this.connections.length > 0) {
              this.activeConnection = this.defaultConnection || this.connections[0].name;
            }
          } catch (error) {
            this.showNotification(`Failed to delete: ${error.message}`, 'error');
          }
        },

        // ‚îÄ‚îÄ‚îÄ Stats & Feed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async loadStats() {
          if (this.statsLoading) return; // Prevent duplicate concurrent calls
          this.statsLoading = true;
          try {
            const data = await this.apiCall('/api/stats', {
              headers: this.connectionHeaders(),
            });
            // Map snake_case API fields to the camelCase properties used in templates.
            // The API returns queue_size but the template reads stats.queueSize.
            this.stats = {
              memories:      data.memories      || 0,
              entities:      data.entities      || 0,
              relationships: data.relationships || 0,
              queueSize:     data.queue_size    || 0,
            };
          } catch (error) {
            // Stats endpoint might not be implemented yet
            console.warn('Stats API not available:', error.message);
          } finally {
            this.statsLoading = false;
          }
        },

        // ‚îÄ‚îÄ‚îÄ Activity Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async loadActivity(force = false) {
          if (this.activityLoading && !force) return; // Prevent duplicate concurrent calls; use force=true for range button clicks
          this.activityLoading = true;
          try {
            const response = await fetch(`/api/activity?range=${this.activityRange}`, {
              headers: this.connectionHeaders(),
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.activityData = data.points || [];
            // Only show empty state if we have data points but they're all zero
            this.activityEmpty = this.activityData.length > 0 && this.activityData.every(p => p.count === 0);
            this.$nextTick(() => this.renderActivityChart(data));
          } catch (error) {
            console.warn('Activity API not available:', error.message);
            this.activityData = [];
            this.activityEmpty = true;
          } finally {
            this.activityLoading = false;
          }
        },

        renderActivityChart(data) {
          const canvas = document.getElementById('activity-chart');
          if (!canvas) return;

          const points = data.points || [];
          const labels = points.map(p => {
            const d = new Date(p.time);
            // Format label based on range
            if (this.activityRange === '5min') {
              return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } else if (this.activityRange === '1hour') {
              return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (this.activityRange === 'week') {
              return d.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
            } else {
              // 24hour
              return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
          });
          const counts = points.map(p => p.count);

          // Detect theme for chart colors
          const isDark = document.documentElement.classList.contains('dark');
          const gridColor   = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
          const tickColor   = isDark ? '#9ca3af' : '#6b7280';
          const tooltipBg   = isDark ? '#1a1a2e' : '#ffffff';
          const tooltipText = isDark ? '#f9fafb' : '#111827';

          // Gradient fill under the line
          const ctx = canvas.getContext('2d');
          const gradient = ctx.createLinearGradient(0, 0, 0, canvas.offsetHeight || 180);
          gradient.addColorStop(0, 'rgba(6, 182, 212, 0.35)');
          gradient.addColorStop(1, 'rgba(6, 182, 212, 0.02)');

          const chartConfig = {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Memories created',
                data: counts,
                fill: true,
                backgroundColor: gradient,
                borderColor: '#06b6d4',
                borderWidth: 2,
                pointBackgroundColor: '#06b6d4',
                pointBorderColor: isDark ? '#1a1a2e' : '#ffffff',
                pointBorderWidth: 2,
                pointRadius: counts.length > 40 ? 0 : 3,
                pointHoverRadius: 5,
                tension: 0.4,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: tooltipBg,
                  titleColor: tooltipText,
                  bodyColor: tickColor,
                  borderColor: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)',
                  borderWidth: 1,
                  padding: 10,
                  cornerRadius: 8,
                  callbacks: {
                    label: ctx => ` ${ctx.parsed.y} ${ctx.parsed.y === 1 ? 'memory' : 'memories'}`,
                  }
                },
              },
              scales: {
                x: {
                  grid: { color: gridColor },
                  ticks: {
                    color: tickColor,
                    maxRotation: 0,
                    autoSkip: true,
                    maxTicksLimit: 8,
                    font: { size: 11 },
                  },
                  border: { color: gridColor },
                },
                y: {
                  grid: { color: gridColor },
                  ticks: {
                    color: tickColor,
                    stepSize: 1,
                    font: { size: 11 },
                    callback: v => Number.isInteger(v) ? v : '',
                  },
                  border: { color: gridColor },
                  beginAtZero: true,
                }
              }
            }
          };

          if (this.activityChart) {
            // Update existing chart data in-place for smooth transition
            this.activityChart.data.labels = labels;
            this.activityChart.data.datasets[0].data = counts;
            // Re-apply gradient (canvas size may have changed)
            const g2 = ctx.createLinearGradient(0, 0, 0, canvas.offsetHeight || 180);
            g2.addColorStop(0, 'rgba(6, 182, 212, 0.35)');
            g2.addColorStop(1, 'rgba(6, 182, 212, 0.02)');
            this.activityChart.data.datasets[0].backgroundColor = g2;
            this.activityChart.update('active');
          } else {
            this.activityChart = new Chart(canvas, chartConfig);
          }
        },

        async loadFeed() {
          if (this.feedLoading) return; // Prevent duplicate concurrent calls
          this.feedLoading = true;
          try {
            const response = await fetch('/api/memories?limit=50', {
              headers: this.connectionHeaders(),
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.feedResults = data.Items || [];
          } catch (error) {
            this.feedResults = [];
          } finally {
            this.feedLoading = false;
          }
        },

        async loadQueue() {
          this.queueLoading = true;
          try {
            const response = await fetch('/api/queue', {
              headers: this.connectionHeaders(),
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.queueStats = data.stats || { channel_depth: 0, pending: 0, processing: 0, enriched: 0, failed: 0, completed_today: 0 };
            this.queueItems = data.items || [];
          } catch (error) {
            console.warn('Queue API not available:', error.message);
            this.queueItems = [];
          } finally {
            this.queueLoading = false;
          }
        },

        async performSearch() {
          this.searchLoading = true;
          try {
            const page = this.searchPage || 1;
            const pageSize = this.searchPageSize || 20;

            // Build URL with unified /api/search endpoint
            let url = `/api/search?page=${page}&page_size=${pageSize}`;

            // If search query exists, add it as filter
            if (this.searchQuery && this.searchQuery.trim()) {
              const query = encodeURIComponent(this.searchQuery.trim());
              url += `&q=${query}`;
            }

            const response = await fetch(url, { headers: this.connectionHeaders() });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();

            // Unified response format from /api/search
            this.searchResults = data.results || [];
            this.searchTotal = data.total || 0;
            this.searchHasMore = data.has_more || false;
          } catch (error) {
            console.error('Search failed:', error);
            this.searchResults = [];
          } finally {
            this.searchLoading = false;
          }
        },

        nextSearchPage() {
          if (this.searchHasMore) {
            this.searchPage++;
            this.performSearch();
          }
        },

        prevSearchPage() {
          if (this.searchPage > 1) {
            this.searchPage--;
            this.performSearch();
          }
        },

        changeSearchPageSize(size) {
          this.searchPageSize = parseInt(size);
          this.searchPage = 1;
          this.performSearch();
        },

        async loadConfig() {
          try {
            // TODO: Implement /api/config endpoint
            // For now, set placeholder values
            this.config = {
              llmProvider: 'OpenAI',
              enrichmentModel: 'gpt-4',
              embeddingModel: 'text-embedding-ada-002'
            };
          } catch (error) {
            console.warn('Config API not available:', error.message);
          }

          // Load user config
          this.loadUserConfig();
        },

        async loadUserConfig() {
          try {
            const data = await this.apiCall('/api/config/user');
            this.userConfig.userName = data.user_name || '';
            this.userConfigOriginal.userName = data.user_name || ''; // Store original for reset
          } catch (error) {
            console.warn('User config API not available:', error.message);
            this.userConfig.userName = '';
            this.userConfigOriginal.userName = '';
          }
        },

        openUserConfigModal() {
          this.editingUserConfig = {
            userName: this.userConfig.userName
          };
          this.userConfigModalOpen = true;
        },

        closeUserConfigModal() {
          this.userConfigModalOpen = false;
          this.editingUserConfig = { userName: '' };
        },

        async saveUserConfigModal() {
          try {
            const data = await this.apiCall('/api/config/user', {
              method: 'POST',
              body: JSON.stringify({ user_name: this.editingUserConfig.userName })
            });
            this.userConfig.userName = data.user_name || '';
            this.userConfigOriginal.userName = data.user_name || '';
            this.showNotification('User configuration saved successfully', 'success');
            this.closeUserConfigModal();
          } catch (error) {
            this.showNotification(`Failed to save user configuration: ${error.message}`, 'error');
          }
        },

        refreshStats() {
          this.loadStats();
          this.showNotification('Stats refreshed', 'success');
        },

        // ‚îÄ‚îÄ‚îÄ Taxonomy Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async loadTaxonomySettings() {
          if (this.taxonomyLoading) return;
          this.taxonomyLoading = true;
          try {
            const connId = this.activeConnection || 'default';
            const resp = await fetch(`/api/connections/${connId}/settings`, {
              headers: this.connectionHeaders(),
            });
            if (!resp.ok) throw new Error('Failed to load settings');
            this.taxonomySettings = await resp.json();
            // Initialize editing state from loaded data
            this.editingEntityTypes = (this.taxonomySettings.custom_entity_types || []).map(t => ({...t}));
            this.editingRelTypes = (this.taxonomySettings.custom_relationship_types || []).map(t => ({...t, keywords_str: (t.keywords || []).join(', ')}));
            this.editingMemoryTypes = (this.taxonomySettings.custom_memory_types || []).map(t => ({...t, keywords_str: (t.keywords || []).join(', ')}));
            this.editingClassifications = (this.taxonomySettings.custom_classification_schemas || []).map(s => ({
              ...s,
              classifications: (s.classifications || []).map(c => ({...c, keywords_str: (c.keywords || []).join(', ')}))
            }));
            this.selectedClassificationCategory = this.taxonomySettings.active_classification_category || '';
          } catch (e) {
            console.error('Failed to load taxonomy settings:', e);
            this.showNotification('Failed to load taxonomy settings', 'error');
          } finally {
            this.taxonomyLoading = false;
          }
        },

        async saveActiveClassificationCategory() {
          const connId = this.activeConnection || 'default';
          try {
            await fetch(`/api/connections/${connId}/settings/active-category`, {
              method: 'PUT',
              headers: {...this.connectionHeaders(), 'Content-Type': 'application/json'},
              body: JSON.stringify({ active_classification_category: this.selectedClassificationCategory }),
            });
            const label = this.selectedClassificationCategory || 'none';
            this.showNotification(`Active category set to "${label}"`, 'success');
          } catch (e) {
            console.error('Failed to save active category:', e);
            this.showNotification('Failed to save active category', 'error');
          }
        },

        openTaxonomyModal(section, editIndex = -1, catIndex = -1) {
          this.taxonomyModalSection = section;
          this.taxonomyModalEditIndex = editIndex;
          this.taxonomyModalCatIndex = catIndex;
          if (section === 'entities') {
            this.taxonomyModalItem = editIndex >= 0 ? {...this.editingEntityTypes[editIndex]} : { name: '', description: '' };
          } else if (section === 'relationships') {
            this.taxonomyModalItem = editIndex >= 0 ? {...this.editingRelTypes[editIndex]} : { name: '', description: '', bidirectional: false, keywords_str: '' };
          } else if (section === 'memory-types') {
            this.taxonomyModalItem = editIndex >= 0 ? {...this.editingMemoryTypes[editIndex]} : { name: '', description: '', keywords_str: '' };
          } else if (section === 'classifications-cat') {
            this.taxonomyModalItem = editIndex >= 0 ? {...this.editingClassifications[editIndex], classifications: [...(this.editingClassifications[editIndex].classifications || [])]} : { category: '', description: '', is_system: false, classifications: [] };
          }
          this.taxonomyModalTagInput = '';
          this.taxonomyModalOpen = true;
        },

        addClassificationTag() {
          const name = this.taxonomyModalTagInput.trim().replace(/,+$/, '');
          if (!name) return;
          const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
          if (!this.taxonomyModalItem.classifications) this.taxonomyModalItem.classifications = [];
          const exists = this.taxonomyModalItem.classifications.some(c => c.name.toLowerCase() === name.toLowerCase());
          if (!exists) this.taxonomyModalItem.classifications.push({ id, name });
          this.taxonomyModalTagInput = '';
        },

        saveTaxonomyModal() {
          const item = this.taxonomyModalItem;
          const idx = this.taxonomyModalEditIndex;
          const s = this.taxonomyModalSection;
          if (s === 'entities') {
            if (!item.name) return;
            if (idx < 0) item.id = this.taxonomyNameToId(item.name);
            if (idx < 0) {
              const allIds = (this.taxonomySettings?.all_entity_types || []);
              if (allIds.includes(item.id)) {
                alert(`"${item.name}" already exists as an entity type.`);
                return;
              }
            }
            if (idx >= 0) this.editingEntityTypes[idx] = {...item};
            else this.editingEntityTypes.push({...item});
            this.saveTaxonomySection('entities');
          } else if (s === 'relationships') {
            if (!item.name) return;
            if (idx < 0) item.id = this.taxonomyNameToId(item.name);
            if (idx < 0) {
              const allIds = (this.taxonomySettings?.all_relationship_types || []);
              if (allIds.includes(item.id)) {
                alert(`"${item.name}" already exists as a relationship type.`);
                return;
              }
            }
            if (idx >= 0) this.editingRelTypes[idx] = {...item};
            else this.editingRelTypes.push({...item});
            this.saveTaxonomySection('relationships');
          } else if (s === 'memory-types') {
            if (!item.name) return;
            if (idx < 0) item.id = this.taxonomyNameToId(item.name);
            if (idx < 0) {
              const allIds = (this.taxonomySettings?.all_memory_types || []);
              if (allIds.includes(item.id)) {
                alert(`"${item.name}" already exists as a memory type.`);
                return;
              }
            }
            if (idx >= 0) this.editingMemoryTypes[idx] = {...item};
            else this.editingMemoryTypes.push({...item});
            this.saveTaxonomySection('memory-types');
          } else if (s === 'classifications-cat') {
            if (!item.category) return;
            if (idx >= 0) this.editingClassifications[idx] = {...item};
            else this.editingClassifications.push({...item});
            this.saveTaxonomySection('classifications');
          }
          this.taxonomyModalOpen = false;
        },

        taxonomyNameToId(name) {
          // Convert to lowercase, replace spaces/hyphens with underscores, strip invalid chars
          // Keep trailing underscore during typing (don't trim) so cursor feels natural
          return (name || '').toLowerCase()
            .replace(/[ -]+/g, '_')
            .replace(/[^a-z0-9_]/g, '');
        },

        confirmRemoveEntityType(index) {
          if (confirm(`Delete entity type "${this.editingEntityTypes[index].name}"?`)) {
            this.editingEntityTypes.splice(index, 1);
            this.saveTaxonomySection('entities');
          }
        },
        confirmRemoveRelType(index) {
          if (confirm(`Delete relationship type "${this.editingRelTypes[index].name}"?`)) {
            this.editingRelTypes.splice(index, 1);
            this.saveTaxonomySection('relationships');
          }
        },
        confirmRemoveMemoryType(index) {
          if (confirm(`Delete memory type "${this.editingMemoryTypes[index].name}"?`)) {
            this.editingMemoryTypes.splice(index, 1);
            this.saveTaxonomySection('memory-types');
          }
        },
        confirmRemoveClassificationCategory(index) {
          if (confirm(`Delete category "${this.editingClassifications[index].category}" and all its classifications?`)) {
            this.editingClassifications.splice(index, 1);
            this.saveTaxonomySection('classifications');
          }
        },

        async saveTaxonomySection(section) {
          this.taxonomySaving = true;
          this.taxonomySaveError = '';
          this.taxonomySaveSuccess = '';
          try {
            const connId = this.activeConnection || 'default';
            let body = {};
            let endpoint = '';
            if (section === 'entities') {
              endpoint = 'entities';
              body = { custom_entity_types: this.editingEntityTypes.filter(t => t.id && t.name) };
            } else if (section === 'relationships') {
              endpoint = 'relationships';
              body = { custom_relationship_types: this.editingRelTypes.filter(t => t.id && t.name).map(t => ({
                ...t, keywords: t.keywords_str ? t.keywords_str.split(',').map(k => k.trim()).filter(Boolean) : []
              })) };
            } else if (section === 'memory-types') {
              endpoint = 'memory-types';
              body = { custom_memory_types: this.editingMemoryTypes.filter(t => t.id && t.name).map(t => ({
                ...t, keywords: t.keywords_str ? t.keywords_str.split(',').map(k => k.trim()).filter(Boolean) : []
              })) };
            } else if (section === 'classifications') {
              endpoint = 'classifications';
              body = { custom_classification_schemas: this.editingClassifications.filter(s => s.category).map(s => ({
                ...s,
                classifications: (s.classifications || []).filter(c => c.id && c.name).map(c => ({
                  ...c, keywords: c.keywords_str ? c.keywords_str.split(',').map(k => k.trim()).filter(Boolean) : []
                }))
              })) };
            }
            const resp = await fetch(`/api/connections/${connId}/settings/${endpoint}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json', ...this.connectionHeaders() },
              body: JSON.stringify(body)
            });
            if (!resp.ok) {
              const err = await resp.json();
              throw new Error(err.error || 'Save failed');
            }
            this.taxonomySaveSuccess = 'Saved successfully!';
            await this.loadTaxonomySettings();
            setTimeout(() => { this.taxonomySaveSuccess = ''; }, 3000);
          } catch (e) {
            this.taxonomySaveError = e.message;
            this.showNotification(`Failed to save ${section}: ${e.message}`, 'error');
          } finally {
            this.taxonomySaving = false;
          }
        },

        // Notifications
        showNotification(message, type = 'info') {
          const id = this.notificationId++;
          this.notifications.push({ id, message, type });
          setTimeout(() => {
            this.notifications = this.notifications.filter(n => n.id !== id);
          }, 5000);
        },

        removeNotification(id) {
          this.notifications = this.notifications.filter(n => n.id !== id);
        },

        // Relationships page state
        relationships: [],
        relationshipsLoading: false,
        relationshipPage: 1,
        relationshipPageSize: 20,
        relationshipTotal: 0,
        relationshipHasMore: false,

        async loadRelationships() {
          this.relationshipsLoading = true;
          this.relationships = [];
          try {
            const page = this.relationshipPage || 1;
            const pageSize = this.relationshipPageSize || 20;
            const response = await fetch(`/api/relationships?page=${page}&page_size=${pageSize}`, {
              headers: this.connectionHeaders(),
            });
            const data = await response.json();
            this.relationships = data.items || [];
            this.relationshipTotal = data.total || 0;
            this.relationshipHasMore = data.has_more || false;
          } catch (error) {
            console.error('Failed to load relationships:', error);
            this.showNotification('Failed to load relationships', 'error');
          } finally {
            this.relationshipsLoading = false;
          }
        },

        nextRelationshipsPage() {
          if (this.relationshipHasMore) {
            this.relationshipPage++;
            this.loadRelationships();
          }
        },

        prevRelationshipsPage() {
          if (this.relationshipPage > 1) {
            this.relationshipPage--;
            this.loadRelationships();
          }
        },

        changeRelationshipPageSize(size) {
          this.relationshipPageSize = parseInt(size);
          this.relationshipPage = 1;
          this.loadRelationships();
        },

        // Entities page state
        entities: [],
        filteredEntities: [],
        entitiesLoading: false,
        entitySearch: '',
        entityTypeFilter: '',
        entityPage: 1,
        entityPageSize: 20,
        entityTotal: 0,
        entityHasMore: false,

        async loadEntities() {
          this.entitiesLoading = true;
          try {
            const page = this.entityPage || 1;
            const pageSize = this.entityPageSize || 20;
            const response = await fetch(`/api/entities?page=${page}&page_size=${pageSize}`, {
              headers: this.connectionHeaders(),
            });
            const data = await response.json();
            this.entities = data.items || [];
            this.filteredEntities = this.entities;
            this.entityTotal = data.total || 0;
            this.entityHasMore = data.has_more || false;
          } catch (error) {
            console.error('Failed to load entities:', error);
            this.showNotification('Failed to load entities', 'error');
          } finally {
            this.entitiesLoading = false;
          }
        },

        nextEntitiesPage() {
          if (this.entityHasMore) {
            this.entityPage++;
            this.loadEntities();
          }
        },

        prevEntitiesPage() {
          if (this.entityPage > 1) {
            this.entityPage--;
            this.loadEntities();
          }
        },

        changeEntityPageSize(size) {
          this.entityPageSize = parseInt(size);
          this.entityPage = 1;
          this.loadEntities();
        },

        filterEntities() {
          let filtered = this.entities;

          if (this.entityTypeFilter) {
            filtered = filtered.filter(e => e.type === this.entityTypeFilter);
          }

          if (this.entitySearch) {
            const search = this.entitySearch.toLowerCase();
            filtered = filtered.filter(e =>
              e.name.toLowerCase().includes(search) ||
              e.type.toLowerCase().includes(search) ||
              (e.description && e.description.toLowerCase().includes(search))
            );
          }

          this.filteredEntities = filtered;
        },

        getEntityIcon(type) {
          const icons = {
            'person': 'üë§',
            'tool': 'üîß',
            'database': 'üóÑÔ∏è',
            'organization': 'üè¢',
            'concept': 'üí°',
            'project': 'üìä',
            'skill': '‚≠ê',
            'event': 'üìÖ',
            'location': 'üìç',
            'product': 'üéÅ'
          };
          return icons[type] || 'üîπ';
        },

        getEntityTypeColor(type) {
          const colors = {
            'person': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
            'tool': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
            'database': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
            'organization': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
            'concept': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300',
            'project': 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300',
            'skill': 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300',
            'event': 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
            'location': 'bg-pink-100 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300',
            'product': 'bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-300'
          };
          return colors[type] || 'bg-gray-100 text-gray-700 dark:bg-gray-700/30 dark:text-gray-300';
        },

        formatRelationshipDate(timestamp) {
          if (!timestamp) return '';
          try {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          } catch {
            return '';
          }
        }
      }));

      // Debug component
      Alpine.data('debugApp', () => ({
        // Debug form state
        form: {
          query: '',
          state: '',
          minScore: 0,
          limit: 10,
        },
        debugLoading: false,
        debugError: '',
        debugResult: null,

        debugInit() {
          // Pre-fill query from URL param if present
          const params = new URLSearchParams(window.location.search);
          if (params.get('query')) this.form.query = params.get('query');
          if (params.get('state')) this.form.state = params.get('state');
        },

        async runTrace() {
          this.debugLoading = true;
          this.debugError = '';
          this.debugResult = null;

          const params = new URLSearchParams({
            query: this.form.query,
            state: this.form.state,
            min_score: this.form.minScore,
            limit: this.form.limit,
          });

          try {
            const resp = await fetch(`/api/debug/recall-trace?${params}`);
            if (!resp.ok) {
              const body = await resp.json().catch(() => ({}));
              throw new Error(body.error || `HTTP ${resp.status}`);
            }
            this.debugResult = await resp.json();

            // Update browser URL so the query can be shared/bookmarked
            history.replaceState({}, '', `?${params}`);
          } catch (err) {
            this.debugError = `Error: ${err.message}`;
          } finally {
            this.debugLoading = false;
          }
        },

        debugIsReturned(memoryID) {
          return this.debugResult?.returned?.includes(memoryID) ?? false;
        },

        debugTotalScoreColor(score) {
          if (score >= 0.75) return 'bg-green-500 dark:bg-green-600';
          if (score >= 0.5)  return 'bg-yellow-400 dark:bg-yellow-500';
          return 'bg-red-400 dark:bg-red-500';
        },

        debugScoreBreakdown(entry) {
          const s = entry.scores || {};
          return [
            ['Text Match',  s.text_match  ?? 0],
            ['Recency',     s.recency     ?? 0],
            ['Importance',  s.importance  ?? 0],
            ['Confidence',  s.confidence  ?? 0],
            ['Usage Boost', s.usage_boost ?? 0],
          ];
        },
      }));

      // Import App component
      Alpine.data('importApp', () => ({
        importType: 'obsidian',
        dirPath: '',
        jobId: null,
        importing: false,
        error: '',
        progress: {},
        result: null,
        pollInterval: null,

        init() {
          // Nothing to initialize on load
        },

        async startImport() {
          this.error = '';
          this.importing = true;
          const endpoint = this.importType === 'obsidian'
            ? '/api/import/obsidian'
            : '/api/import/markdown';

          try {
            const resp = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ path: this.dirPath.trim() })
            });
            if (!resp.ok) {
              const body = await resp.json().catch(() => ({}));
              throw new Error(body.error || `HTTP ${resp.status}`);
            }
            const data = await resp.json();
            this.jobId = data.job_id;
            this.startPolling();
          } catch (err) {
            this.error = err.message;
          } finally {
            this.importing = false;
          }
        },

        startPolling() {
          this.pollInterval = setInterval(() => this.pollStatus(), 1000);
        },

        async pollStatus() {
          if (!this.jobId) return;
          try {
            const resp = await fetch(`/api/import/status/${this.jobId}`);
            if (!resp.ok) return;
            const data = await resp.json();

            if (data.progress) {
              // Complete response with nested progress + result
              this.progress = data.progress;
              this.result = data.result;
            } else {
              // Still running - top-level is the progress object
              this.progress = data;
            }

            if (this.progress.status === 'complete' || this.progress.status === 'failed') {
              clearInterval(this.pollInterval);
            }
          } catch (err) {
            console.warn('Poll error:', err);
          }
        },

        resetForm() {
          clearInterval(this.pollInterval);
          this.jobId = null;
          this.progress = {};
          this.result = null;
          this.error = '';
          this.importing = false;
        }
      }));

      // Graph Explorer component
      Alpine.data('graphExplorer', () => ({
        // Entity search
        entitySearch: '',
        entitySearchResults: [],
        showEntityDropdown: false,
        selectedEntity: null,

        // Graph state
        graphDepth: 1,
        graphLayout: 'fcose',
        graphLoading: false,
        graphMeta: { center_id: '', depth: 1, node_count: 0, edge_count: 0 },
        graphTypeLegend: [],
        hoveredNode: null,

        // Cytoscape instance
        cy: null,

        // Entity type color palette
        typeColors: {
          person:       '#3B82F6', // blue
          organization: '#8B5CF6', // violet
          project:      '#10B981', // emerald
          technology:   '#F59E0B', // amber
          location:     '#EF4444', // red
          concept:      '#6366F1', // indigo
          event:        '#EC4899', // pink
          tool:         '#F97316', // orange
          product:      '#14B8A6', // teal
          document:     '#6B7280', // gray
          topic:        '#8B5CF6', // violet
          language:     '#06B6D4', // cyan
          framework:    '#22C55E', // green
          service:      '#A855F7', // purple
          platform:     '#0EA5E9', // sky
          role:         '#D946EF', // fuchsia
          skill:        '#84CC16', // lime
          database:     '#F43F5E', // rose
        },
        defaultColor: '#9CA3AF', // gray-400

        graphInit() {
          // Register fcose layout if available
          if (typeof cytoscapeFcose !== 'undefined') {
            cytoscape.use(cytoscapeFcose);
          }
        },

        getTypeColor(type) {
          return this.typeColors[type] || this.defaultColor;
        },

        async searchEntities() {
          if (!this.entitySearch || this.entitySearch.length < 2) {
            this.entitySearchResults = [];
            this.showEntityDropdown = false;
            return;
          }

          try {
            const response = await fetch(`/api/entities?search=${encodeURIComponent(this.entitySearch)}&limit=10`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.entitySearchResults = data.items || [];
            this.showEntityDropdown = this.entitySearchResults.length > 0;
          } catch (error) {
            console.warn('Entity search failed:', error);
            this.entitySearchResults = [];
          }
        },

        selectEntity(entity) {
          this.selectedEntity = entity;
          this.entitySearch = entity.name;
          this.showEntityDropdown = false;
          this.loadGraph(entity.id);
        },

        clearSelection() {
          this.selectedEntity = null;
          this.entitySearch = '';
          this.entitySearchResults = [];
          this.graphMeta = { center_id: '', depth: 1, node_count: 0, edge_count: 0 };
          this.graphTypeLegend = [];
          this.hoveredNode = null;
          if (this.cy) {
            this.cy.destroy();
            this.cy = null;
          }
        },

        reloadGraph() {
          if (this.selectedEntity) {
            this.loadGraph(this.selectedEntity.id);
          }
        },

        async loadGraph(entityId) {
          this.graphLoading = true;
          this.hoveredNode = null;

          try {
            const url = `/api/entities/${encodeURIComponent(entityId)}/graph?depth=${this.graphDepth}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();

            this.graphMeta = data.meta || {};
            this.renderGraph(data);
          } catch (error) {
            console.error('Failed to load graph:', error);
          } finally {
            this.graphLoading = false;
          }
        },

        renderGraph(data) {
          // Destroy previous instance
          if (this.cy) {
            this.cy.destroy();
            this.cy = null;
          }

          const nodes = (data.nodes || []).map(n => ({
            group: 'nodes',
            data: {
              id: n.id,
              label: n.name,
              type: n.type,
              description: n.description || '',
              memory_count: n.memory_count || 0,
              isCenter: n.id === data.meta.center_id,
            }
          }));

          const edges = (data.edges || []).map(e => ({
            group: 'edges',
            data: {
              id: e.id,
              source: e.source,
              target: e.target,
              label: e.type,
              weight: e.weight || 1,
            }
          }));

          // Build type legend from unique types
          const typeSet = new Set((data.nodes || []).map(n => n.type));
          this.graphTypeLegend = [...typeSet].sort().map(t => ({
            type: t,
            color: this.getTypeColor(t),
          }));

          // We need to wait for the container to be visible
          this.$nextTick(() => {
            const container = document.getElementById('cy');
            if (!container) return;

            const self = this;

            this.cy = cytoscape({
              container: container,
              elements: [...nodes, ...edges],
              style: [
                {
                  selector: 'node',
                  style: {
                    'label': 'data(label)',
                    'text-valign': 'bottom',
                    'text-halign': 'center',
                    'font-size': '11px',
                    'font-family': 'system-ui, -apple-system, sans-serif',
                    'color': '#374151',
                    'text-margin-y': 6,
                    'background-color': function(ele) {
                      return self.getTypeColor(ele.data('type'));
                    },
                    'width': function(ele) {
                      return Math.max(20, Math.min(60, 20 + (ele.data('memory_count') || 0) * 2));
                    },
                    'height': function(ele) {
                      return Math.max(20, Math.min(60, 20 + (ele.data('memory_count') || 0) * 2));
                    },
                    'border-width': 2,
                    'border-color': '#ffffff',
                    'text-wrap': 'ellipsis',
                    'text-max-width': '80px',
                  }
                },
                {
                  selector: 'node[?isCenter]',
                  style: {
                    'border-width': 4,
                    'border-color': '#1F2937',
                    'font-weight': 'bold',
                    'font-size': '13px',
                  }
                },
                {
                  selector: 'node:selected',
                  style: {
                    'border-width': 4,
                    'border-color': '#2563EB',
                    'overlay-color': '#2563EB',
                    'overlay-opacity': 0.1,
                  }
                },
                {
                  selector: 'edge',
                  style: {
                    'width': function(ele) {
                      return Math.max(1, Math.min(5, (ele.data('weight') || 1) * 2));
                    },
                    'line-color': '#D1D5DB',
                    'target-arrow-color': '#D1D5DB',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'label': 'data(label)',
                    'font-size': '9px',
                    'color': '#9CA3AF',
                    'text-rotation': 'autorotate',
                    'text-margin-y': -8,
                  }
                },
                {
                  selector: 'edge:selected',
                  style: {
                    'line-color': '#2563EB',
                    'target-arrow-color': '#2563EB',
                    'width': 3,
                  }
                },
              ],
              layout: { name: 'grid' }, // Temporary; we run the real layout below
              minZoom: 0.1,
              maxZoom: 4,
              wheelSensitivity: 0.3,
            });

            // Run the chosen layout
            this.runLayout();

            // Events: hover to show node detail
            this.cy.on('mouseover', 'node', (evt) => {
              const d = evt.target.data();
              self.hoveredNode = {
                name: d.label,
                type: d.type,
                description: d.description,
                memory_count: d.memory_count,
              };
            });

            this.cy.on('mouseout', 'node', () => {
              self.hoveredNode = null;
            });

            // Double-click a node to re-center graph on it
            this.cy.on('dblclick', 'node', (evt) => {
              const nodeData = evt.target.data();
              self.selectedEntity = {
                id: nodeData.id,
                name: nodeData.label,
                type: nodeData.type,
                memory_count: nodeData.memory_count,
              };
              self.entitySearch = nodeData.label;
              self.loadGraph(nodeData.id);
            });
          });
        },

        runLayout() {
          if (!this.cy) return;

          let layoutConfig;

          switch (this.graphLayout) {
            case 'fcose':
              layoutConfig = {
                name: 'fcose',
                animate: true,
                animationDuration: 500,
                fit: true,
                padding: 50,
                nodeSeparation: 100,
                idealEdgeLength: 120,
                nodeRepulsion: 8000,
                edgeElasticity: 0.45,
                gravity: 0.25,
                gravityRange: 3.8,
                // Cluster by entity type
                packComponents: true,
              };
              break;
            case 'cose':
              layoutConfig = {
                name: 'cose',
                animate: true,
                animationDuration: 500,
                fit: true,
                padding: 50,
                nodeRepulsion: function() { return 6000; },
                idealEdgeLength: function() { return 100; },
                edgeElasticity: function() { return 100; },
              };
              break;
            case 'circle':
              layoutConfig = { name: 'circle', animate: true, fit: true, padding: 50 };
              break;
            case 'concentric':
              layoutConfig = {
                name: 'concentric',
                animate: true,
                fit: true,
                padding: 50,
                concentric: function(node) {
                  return node.data('isCenter') ? 10 : node.degree();
                },
                levelWidth: function() { return 2; },
              };
              break;
            case 'grid':
              layoutConfig = { name: 'grid', animate: true, fit: true, padding: 50 };
              break;
            default:
              layoutConfig = { name: 'fcose', animate: true, fit: true, padding: 50 };
          }

          // Run layout and auto-center when complete
          const layout = this.cy.layout(layoutConfig);
          layout.on('layoutstop', () => {
            this.cy.fit(undefined, 50);
          });
          layout.run();
        },

        fitGraph() {
          if (this.cy) {
            this.cy.fit(undefined, 50);
          }
        },
      }));
    });

    // Navbar theming is handled by CSS: .app-nav uses CSS variables
    // that automatically update when html.dark / html.light classes toggle.
  </script>
</body>
</html>
